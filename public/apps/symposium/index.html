<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>The Symposium — Olympus</title>

    <!-- Firebase SDK (compat) -->
    <script defer src="/__/firebase/12.9.0/firebase-app-compat.js"></script>
    <script defer src="/__/firebase/12.9.0/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/12.9.0/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>

    <!-- Shared Olympus styles -->
    <link rel="stylesheet" href="/styles/app.css" />

    <!-- App-specific styles -->
    <style>
      /* ── Toolbar ─────────────────────────────────────── */
      .toolbar {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 1.5rem;
      }

      /* ── Oracle search bar ───────────────────────────── */
      .oracle-search-row {
        margin-bottom: 1rem;
      }

      .oracle-search-wrapper {
        position: relative;
        display: flex;
        align-items: center;
      }

      .oracle-search-icon {
        position: absolute;
        left: 0.85rem;
        font-size: 0.9rem;
        pointer-events: none;
      }

      .oracle-search-input {
        width: 100%;
        padding: 0.65rem 2.5rem 0.65rem 2.4rem;
        font-size: 0.95rem;
        font-family: inherit;
        color: #e0e0e0;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        outline: none;
        transition:
          border-color 0.2s,
          box-shadow 0.2s;
      }

      .oracle-search-input:focus {
        border-color: rgba(255, 183, 77, 0.5);
        box-shadow: 0 0 0 3px rgba(255, 183, 77, 0.1);
      }

      .oracle-search-input::placeholder {
        color: #4b5563;
        font-style: italic;
      }

      .oracle-clear-btn {
        position: absolute;
        right: 0.65rem;
        background: none;
        border: none;
        color: #546e7a;
        font-size: 0.9rem;
        cursor: pointer;
        padding: 0.2rem 0.4rem;
        line-height: 1;
        border-radius: 4px;
        font-family: inherit;
      }

      .oracle-clear-btn:hover {
        color: #e0e0e0;
      }

      /* ── Browse controls row ─────────────────────────── */
      .browse-controls-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-bottom: 1.25rem;
      }

      .sort-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .sort-label {
        font-size: 0.75rem;
        color: #546e7a;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .sort-select {
        padding: 0.4rem 1.8rem 0.4rem 0.75rem;
        font-size: 0.8rem;
        font-family: inherit;
        color: #90a4ae;
        background: rgba(255, 255, 255, 0.05)
          url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath fill='%2390a4ae' d='M6 8L1 3h10z'/%3E%3C/svg%3E")
          no-repeat right 0.6rem center;
        appearance: none;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        outline: none;
        cursor: pointer;
      }

      .sort-select option {
        background: #111827;
        color: #e0e0e0;
      }

      .stock-toggle-group {
        display: flex;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 8px;
        overflow: hidden;
      }

      .stock-toggle-btn {
        flex: 1;
        padding: 0.35rem 0.75rem;
        font-size: 0.75rem;
        font-family: inherit;
        color: #546e7a;
        background: none;
        border: none;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        transition:
          color 0.2s,
          background 0.2s;
      }

      .stock-toggle-btn + .stock-toggle-btn {
        border-left: 1px solid rgba(255, 255, 255, 0.08);
      }

      .stock-toggle-btn.active {
        color: #ffb74d;
        background: rgba(255, 183, 77, 0.1);
      }

      .stock-toggle-btn:hover:not(.active) {
        color: #90a4ae;
      }

      /* ── Category browse grid ────────────────────────── */
      .category-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
        gap: 0.6rem;
        margin-bottom: 1.5rem;
      }

      .category-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0.75rem 0.5rem;
        font-family: inherit;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        cursor: pointer;
        color: #90a4ae;
        text-align: center;
        transition:
          color 0.2s,
          background 0.2s,
          border-color 0.2s;
      }

      .category-card:hover {
        color: #e0e0e0;
        border-color: rgba(255, 183, 77, 0.25);
      }

      .category-card.active {
        color: #ffb74d;
        background: rgba(255, 183, 77, 0.1);
        border-color: rgba(255, 183, 77, 0.4);
      }

      .category-card-count {
        font-size: 1.4rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 0.3rem;
      }

      .category-card-name {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }

      /* ── Ingredient count ────────────────────────────── */
      .ingredient-count {
        text-align: center;
        font-size: 0.8rem;
        color: #546e7a;
        margin-bottom: 1.5rem;
        letter-spacing: 0.05em;
      }

      /* ── Ingredient cards ────────────────────────────── */
      .ingredient-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .ingredient-card {
        background: rgba(17, 24, 39, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 14px;
        padding: 1.25rem 1.5rem;
        transition: border-color 0.3s;
      }

      .ingredient-card:hover {
        border-color: rgba(255, 183, 77, 0.2);
      }

      .ingredient-card-header {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
      }

      .ingredient-card-header > div:first-child {
        flex: 1;
        min-width: 0;
      }

      .ingredient-name {
        font-size: 1.05rem;
        font-weight: 600;
        color: #e0e0e0;
        margin: 0;
      }

      .ingredient-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }

      .badge {
        display: inline-block;
        padding: 0.2rem 0.6rem;
        font-size: 0.7rem;
        border-radius: 999px;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }

      .badge-category {
        color: #ffb74d;
        background: rgba(255, 183, 77, 0.12);
        border: 1px solid rgba(255, 183, 77, 0.2);
      }

      .badge-subcategory {
        color: #90a4ae;
        background: rgba(144, 164, 174, 0.1);
        border: 1px solid rgba(144, 164, 174, 0.15);
      }

      .badge-stock {
        font-weight: 600;
      }

      .badge-in-stock {
        color: #66bb6a;
        background: rgba(102, 187, 106, 0.1);
        border: 1px solid rgba(102, 187, 106, 0.2);
      }

      .badge-out-of-stock {
        color: #ef5350;
        background: rgba(239, 83, 80, 0.1);
        border: 1px solid rgba(239, 83, 80, 0.2);
      }

      .ingredient-details {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 0.75rem;
        font-size: 0.85rem;
        color: #90a4ae;
      }

      .ingredient-detail-label {
        color: #546e7a;
      }

      .ingredient-notes {
        margin-top: 0.5rem;
        font-size: 0.85rem;
        color: #78909c;
        font-style: italic;
      }

      .ingredient-actions {
        display: flex;
        gap: 0.5rem;
        flex-shrink: 0;
      }

      .btn-icon {
        padding: 0.35rem 0.65rem;
        font-size: 0.7rem;
        font-family: inherit;
        color: #546e7a;
        background: none;
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 6px;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        transition:
          color 0.2s,
          border-color 0.2s;
      }

      .btn-edit:hover {
        color: #ffb74d;
        border-color: rgba(255, 183, 77, 0.3);
      }

      .btn-delete:hover {
        color: #ef5350;
        border-color: rgba(239, 83, 80, 0.3);
      }

      /* ── Empty state ─────────────────────────────────── */
      .empty-state {
        text-align: center;
        padding: 3rem 2rem;
      }

      .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 0.75rem;
        display: block;
        opacity: 0.5;
      }

      .empty-state-text {
        font-size: 0.95rem;
        color: #546e7a;
        font-style: italic;
        line-height: 1.6;
      }

      /* ── Modal ───────────────────────────────────────── */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 1rem;
        opacity: 0;
        visibility: hidden;
        transition:
          opacity 0.2s,
          visibility 0.2s;
      }

      .modal-overlay.open {
        opacity: 1;
        visibility: visible;
      }

      .modal-dialog {
        background: #111827;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        width: 100%;
        max-width: 520px;
        max-height: 90vh;
        overflow-y: auto;
        padding: 2rem;
      }

      .modal-title {
        font-size: 1.2rem;
        font-weight: 700;
        color: #e0e0e0;
        margin: 0 0 1.5rem;
      }

      /* ── Form ────────────────────────────────────────── */
      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
      }

      .form-group.full-width {
        grid-column: 1 / -1;
      }

      .form-label {
        font-size: 0.75rem;
        color: #90a4ae;
        text-transform: uppercase;
        letter-spacing: 0.06em;
      }

      .form-input,
      .form-select,
      .form-textarea {
        padding: 0.65rem 0.85rem;
        font-size: 0.9rem;
        font-family: inherit;
        color: #e0e0e0;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        outline: none;
        transition:
          border-color 0.2s,
          box-shadow 0.2s;
      }

      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        border-color: rgba(255, 183, 77, 0.5);
        box-shadow: 0 0 0 3px rgba(255, 183, 77, 0.1);
      }

      .form-input::placeholder,
      .form-textarea::placeholder {
        color: #4b5563;
        font-style: italic;
      }

      .form-select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2390a4ae' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        padding-right: 2rem;
      }

      .form-select option {
        background: #111827;
        color: #e0e0e0;
      }

      .form-textarea {
        resize: vertical;
        min-height: 60px;
      }

      .form-checkbox-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding-top: 0.25rem;
      }

      .form-checkbox {
        accent-color: #ffb74d;
        width: 16px;
        height: 16px;
      }

      .form-checkbox-label {
        font-size: 0.85rem;
        color: #e0e0e0;
      }

      .form-error {
        font-size: 0.75rem;
        color: #ef5350;
        min-height: 1em;
      }

      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        margin-top: 1.5rem;
      }

      .btn-cancel {
        padding: 0.6rem 1.2rem;
        font-size: 0.85rem;
        font-family: inherit;
        color: #90a4ae;
        background: none;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        cursor: pointer;
        transition:
          color 0.2s,
          border-color 0.2s;
      }

      .btn-cancel:hover {
        color: #e0e0e0;
        border-color: rgba(255, 255, 255, 0.2);
      }

      /* ── Amphora bottle level indicator ──────────── */
      .amphora-indicator {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.2rem;
        padding: 0.25rem 0.5rem;
        background: none;
        border: 1px solid transparent;
        border-radius: 8px;
        cursor: pointer;
        transition:
          border-color 0.2s,
          background 0.2s;
        flex-shrink: 0;
        font-family: inherit;
        color: inherit;
      }

      .amphora-indicator:hover {
        border-color: rgba(255, 183, 77, 0.3);
        background: rgba(255, 183, 77, 0.05);
      }

      .amphora-indicator:focus-visible {
        outline: 2px solid rgba(255, 183, 77, 0.7);
        outline-offset: 2px;
      }

      .amphora-label {
        font-size: 0.6rem;
        color: #546e7a;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        white-space: nowrap;
      }

      .amphora-indicator.amphora-sealed .amphora-label {
        color: #37474f;
      }

      /* ── Amphora level popover ───────────────────── */
      .amphora-popover {
        position: fixed;
        z-index: 1100;
        background: #111827;
        border: 1px solid rgba(255, 183, 77, 0.2);
        border-radius: 12px;
        padding: 1rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        min-width: 200px;
        opacity: 0;
        visibility: hidden;
        transition:
          opacity 0.15s,
          visibility 0.15s;
      }

      .amphora-popover.open {
        opacity: 1;
        visibility: visible;
      }

      .amphora-popover-title {
        font-size: 0.75rem;
        color: #90a4ae;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        margin-bottom: 0.75rem;
        text-align: center;
      }

      .amphora-level-options {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .amphora-level-btn {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
        font-family: inherit;
        color: #90a4ae;
        background: none;
        border: 1px solid transparent;
        border-radius: 8px;
        cursor: pointer;
        transition:
          color 0.2s,
          background 0.2s,
          border-color 0.2s;
        text-align: left;
        width: 100%;
      }

      .amphora-level-btn:hover {
        color: #e0e0e0;
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
      }

      .amphora-level-btn.active {
        color: #ffb74d;
        background: rgba(255, 183, 77, 0.08);
        border-color: rgba(255, 183, 77, 0.25);
      }

      .amphora-level-btn:focus-visible {
        outline: 2px solid rgba(255, 183, 77, 0.7);
        outline-offset: 2px;
      }

      .amphora-level-divider {
        height: 1px;
        background: rgba(255, 255, 255, 0.06);
        margin: 0.35rem 0;
      }

      .amphora-sealed-btn {
        color: #546e7a;
        font-style: italic;
      }

      @media (max-width: 600px) {
        .form-grid {
          grid-template-columns: 1fr;
        }

        .toolbar {
          justify-content: stretch;
        }

        .toolbar .app-btn {
          width: 100%;
        }

        .browse-controls-row {
          flex-direction: column;
          align-items: stretch;
        }

        .sort-group {
          justify-content: space-between;
        }

        .sort-select {
          flex: 1;
        }

        .stock-toggle-group {
          width: 100%;
        }

        .category-grid {
          grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
        }

        .ingredient-card-header {
          flex-direction: column;
        }

        .amphora-actions-row {
          display: flex;
          justify-content: space-between;
          align-items: center;
          align-self: stretch;
        }

        .ingredient-actions {
          align-self: flex-end;
        }

        .amphora-popover {
          left: 50% !important;
          transform: translateX(-50%);
          top: auto !important;
          bottom: 1rem;
          max-width: calc(100vw - 2rem);
        }
      }

      /* ── View tabs ─────────────────────────────────── */
      .view-tabs {
        display: flex;
        justify-content: center;
        gap: 0;
        margin-bottom: 2rem;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 10px;
        overflow: hidden;
      }

      .view-tab {
        flex: 1;
        max-width: 200px;
        padding: 0.6rem 1.25rem;
        font-size: 0.85rem;
        font-family: inherit;
        font-weight: 600;
        color: #546e7a;
        background: none;
        border: none;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        transition:
          color 0.2s,
          background 0.2s;
      }

      .view-tab + .view-tab {
        border-left: 1px solid rgba(255, 255, 255, 0.08);
      }

      .view-tab.active[data-view='ingredients'] {
        color: #ffb74d;
        background: rgba(255, 183, 77, 0.1);
      }

      .view-tab.active[data-view='equipment'] {
        color: #4dd0e1;
        background: rgba(77, 208, 225, 0.1);
      }

      .view-tab:hover:not(.active) {
        color: #90a4ae;
      }

      /* ── Equipment cards ───────────────────────────── */
      .equipment-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .equipment-card {
        background: rgba(17, 24, 39, 0.7);
        border: 1px solid rgba(77, 208, 225, 0.1);
        border-left: 3px solid rgba(77, 208, 225, 0.3);
        border-radius: 14px;
        padding: 1.25rem 1.5rem;
        transition: border-color 0.3s;
      }

      .equipment-card:hover {
        border-color: rgba(77, 208, 225, 0.3);
        border-left-color: rgba(77, 208, 225, 0.6);
      }

      .equipment-count {
        text-align: center;
        font-size: 0.8rem;
        color: #546e7a;
        margin-bottom: 1.5rem;
        letter-spacing: 0.05em;
      }

      /* ── Condition badges ──────────────────────────── */
      .badge-condition {
        font-weight: 600;
      }

      .badge-condition-good {
        color: #66bb6a;
        background: rgba(102, 187, 106, 0.1);
        border: 1px solid rgba(102, 187, 106, 0.2);
      }

      .badge-condition-fair {
        color: #ffa726;
        background: rgba(255, 167, 38, 0.1);
        border: 1px solid rgba(255, 167, 38, 0.2);
      }

      .badge-condition-replace {
        color: #ef5350;
        background: rgba(239, 83, 80, 0.15);
        border: 1px solid rgba(239, 83, 80, 0.3);
        font-weight: 700;
      }

      /* ── Condition filter toggle ────────────────────── */
      .condition-toggle-group {
        display: flex;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 8px;
        overflow: hidden;
      }

      .condition-toggle-btn {
        flex: 1;
        padding: 0.35rem 0.75rem;
        font-size: 0.75rem;
        font-family: inherit;
        color: #546e7a;
        background: none;
        border: none;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        transition:
          color 0.2s,
          background 0.2s;
      }

      .condition-toggle-btn + .condition-toggle-btn {
        border-left: 1px solid rgba(255, 255, 255, 0.08);
      }

      .condition-toggle-btn.active {
        color: #4dd0e1;
        background: rgba(77, 208, 225, 0.1);
      }

      .condition-toggle-btn:hover:not(.active) {
        color: #90a4ae;
      }

      /* ── Equipment button accent ────────────────────── */
      .app-btn-equipment {
        background: linear-gradient(135deg, #4dd0e1, #00acc1, #0097a7);
      }

      .app-btn-equipment:hover {
        box-shadow: 0 4px 16px rgba(77, 208, 225, 0.3);
      }

      /* ── Equipment category grid accent ─────────────── */
      #category-grid-equip .category-card:hover {
        border-color: rgba(77, 208, 225, 0.25);
      }

      #category-grid-equip .category-card.active {
        color: #4dd0e1;
        background: rgba(77, 208, 225, 0.1);
        border-color: rgba(77, 208, 225, 0.4);
      }

      /* ── Equipment modal focus colors ───────────────── */
      .modal-dialog-equipment .form-input:focus,
      .modal-dialog-equipment .form-select:focus,
      .modal-dialog-equipment .form-textarea:focus {
        border-color: rgba(77, 208, 225, 0.5);
        box-shadow: 0 0 0 3px rgba(77, 208, 225, 0.1);
      }

      @media (max-width: 600px) {
        .view-tabs {
          margin-bottom: 1.5rem;
        }

        .view-tab {
          font-size: 0.75rem;
          padding: 0.5rem 0.75rem;
        }

        .condition-toggle-group {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <!-- Shared header — rendered by app-header.js -->
    <div id="appHeader"></div>

    <!-- Auth guard — shown while checking auth state -->
    <div class="app-loading" id="app-loading">
      <div class="app-spinner"></div>
      <p class="app-loading-text">Consulting the Oracle&hellip;</p>
    </div>

    <!-- Main content — hidden until authenticated -->
    <main class="app-main hidden" id="app-main">
      <h1 class="app-title">The Symposium</h1>
      <p class="app-subtitle">Where Dionysus keeps his ledger</p>
      <div class="app-divider"></div>

      <!-- View tabs: Ingredients / Equipment -->
      <div class="view-tabs" role="tablist" aria-label="Inventory view">
        <button
          class="view-tab active"
          id="tab-ingredients"
          type="button"
          role="tab"
          aria-selected="true"
          aria-controls="panel-ingredients"
          data-view="ingredients"
        >
          &#127863; Ingredients
        </button>
        <button
          class="view-tab"
          id="tab-equipment"
          type="button"
          role="tab"
          aria-selected="false"
          aria-controls="panel-equipment"
          data-view="equipment"
        >
          &#128295; Equipment
        </button>
      </div>

      <!-- Ingredients panel -->
      <div id="panel-ingredients" role="tabpanel" aria-labelledby="tab-ingredients">
        <div class="toolbar">
          <button class="app-btn" id="btn-add" type="button">+ Add Ingredient</button>
        </div>

        <!-- Oracle search bar -->
        <div class="oracle-search-row">
          <div class="oracle-search-wrapper">
            <span class="oracle-search-icon" aria-hidden="true">&#x1f52e;</span>
            <input
              class="oracle-search-input"
              id="oracle-search"
              type="text"
              placeholder="Consult the Oracle&hellip;"
              autocomplete="off"
            />
            <button
              class="oracle-clear-btn hidden"
              id="oracle-clear"
              type="button"
              aria-label="Clear search"
            >
              &#x2715;
            </button>
          </div>
        </div>

        <!-- Browse controls: sort + stock filter -->
        <div class="browse-controls-row">
          <div class="sort-group">
            <label class="sort-label" for="sort-select">Sort</label>
            <select class="sort-select" id="sort-select">
              <option value="category">Category</option>
              <option value="alpha">Alphabetical</option>
              <option value="stock">Stock Status</option>
            </select>
          </div>
          <div class="stock-toggle-group" role="group" aria-label="Stock filter">
            <button
              class="stock-toggle-btn active"
              id="stock-btn-all"
              type="button"
              data-filter="all"
            >
              All
            </button>
            <button class="stock-toggle-btn" id="stock-btn-in" type="button" data-filter="in-stock">
              In Stock
            </button>
            <button
              class="stock-toggle-btn"
              id="stock-btn-out"
              type="button"
              data-filter="out-of-stock"
            >
              Out of Stock
            </button>
          </div>
        </div>

        <!-- Category browse grid -->
        <div class="category-grid" id="category-grid"></div>

        <div class="ingredient-count hidden" id="ingredient-count"></div>

        <div class="ingredient-list" id="ingredient-list"></div>

        <div class="empty-state" id="empty-state">
          <span class="empty-state-icon" aria-hidden="true">&#127863;</span>
          <p class="empty-state-text">The Cellar awaits its first offering.</p>
        </div>
      </div>

      <!-- Equipment panel -->
      <div id="panel-equipment" role="tabpanel" aria-labelledby="tab-equipment" class="hidden">
        <div class="toolbar">
          <button class="app-btn app-btn-equipment" id="btn-add-equipment" type="button">
            + Add Equipment
          </button>
        </div>

        <!-- Oracle search bar (equipment) -->
        <div class="oracle-search-row">
          <div class="oracle-search-wrapper">
            <span class="oracle-search-icon" aria-hidden="true">&#x1f50d;</span>
            <input
              class="oracle-search-input"
              id="oracle-search-equip"
              type="text"
              placeholder="Search equipment&hellip;"
              autocomplete="off"
            />
            <button
              class="oracle-clear-btn hidden"
              id="oracle-clear-equip"
              type="button"
              aria-label="Clear search"
            >
              &#x2715;
            </button>
          </div>
        </div>

        <!-- Browse controls: sort + condition filter -->
        <div class="browse-controls-row">
          <div class="sort-group">
            <label class="sort-label" for="sort-select-equip">Sort</label>
            <select class="sort-select" id="sort-select-equip">
              <option value="category">Category</option>
              <option value="alpha">Alphabetical</option>
              <option value="condition">Condition</option>
            </select>
          </div>
          <div class="condition-toggle-group" role="group" aria-label="Condition filter">
            <button
              class="condition-toggle-btn active"
              id="cond-btn-all"
              type="button"
              data-filter="all"
            >
              All
            </button>
            <button
              class="condition-toggle-btn"
              id="cond-btn-good"
              type="button"
              data-filter="good"
            >
              Good
            </button>
            <button
              class="condition-toggle-btn"
              id="cond-btn-fair"
              type="button"
              data-filter="fair"
            >
              Fair
            </button>
            <button
              class="condition-toggle-btn"
              id="cond-btn-replace"
              type="button"
              data-filter="replace"
            >
              Replace
            </button>
          </div>
        </div>

        <!-- Category browse grid (equipment) -->
        <div class="category-grid" id="category-grid-equip"></div>

        <div class="equipment-count hidden" id="equipment-count"></div>

        <div class="equipment-list" id="equipment-list"></div>

        <div class="empty-state" id="empty-state-equip">
          <span class="empty-state-icon" aria-hidden="true">&#128295;</span>
          <p class="empty-state-text">The Workshop awaits its first tool.</p>
        </div>
      </div>
    </main>

    <!-- Modal overlay -->
    <div class="modal-overlay" id="modal-overlay">
      <div class="modal-dialog" role="dialog" aria-labelledby="modal-title">
        <h2 class="modal-title" id="modal-title">Add Ingredient</h2>
        <form id="ingredient-form" novalidate>
          <div class="form-grid">
            <div class="form-group full-width">
              <label class="form-label" for="field-name">Name</label>
              <input
                class="form-input"
                id="field-name"
                type="text"
                placeholder="e.g. Buffalo Trace"
                required
              />
              <span class="form-error" id="error-name"></span>
            </div>

            <div class="form-group">
              <label class="form-label" for="field-category">Category</label>
              <select class="form-select" id="field-category" required>
                <option value="">Select&hellip;</option>
              </select>
              <span class="form-error" id="error-category"></span>
            </div>

            <div class="form-group">
              <label class="form-label" for="field-subcategory">Subcategory</label>
              <select class="form-select" id="field-subcategory" required>
                <option value="">Select category first</option>
              </select>
              <span class="form-error" id="error-subcategory"></span>
            </div>

            <div class="form-group">
              <label class="form-label" for="field-unit">Unit</label>
              <select class="form-select" id="field-unit" required>
                <option value="">Select&hellip;</option>
                <option value="oz">oz</option>
                <option value="ml">ml</option>
                <option value="dash">dash</option>
                <option value="each">each</option>
                <option value="splash">splash</option>
              </select>
              <span class="form-error" id="error-unit"></span>
            </div>

            <div class="form-group">
              <label class="form-label" for="field-quantity">Quantity</label>
              <input
                class="form-input"
                id="field-quantity"
                type="number"
                min="0"
                step="0.25"
                value="0"
              />
              <span class="form-error" id="error-quantity"></span>
            </div>

            <div class="form-group">
              <div class="form-checkbox-row">
                <input class="form-checkbox" id="field-instock" type="checkbox" />
                <label class="form-checkbox-label" for="field-instock">In Stock</label>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="field-threshold">Low Stock Threshold</label>
              <input
                class="form-input"
                id="field-threshold"
                type="number"
                min="0"
                step="0.25"
                value="0"
              />
            </div>

            <div class="form-group full-width">
              <label class="form-label" for="field-tags">Tags (comma-separated)</label>
              <input
                class="form-input"
                id="field-tags"
                type="text"
                placeholder="e.g. bourbon, whiskey, american"
              />
            </div>

            <div class="form-group full-width">
              <label class="form-label" for="field-notes">Notes</label>
              <textarea
                class="form-textarea"
                id="field-notes"
                placeholder="Tasting notes, brand info&hellip;"
                rows="2"
              ></textarea>
            </div>

            <div class="form-group">
              <div class="form-checkbox-row">
                <input class="form-checkbox" id="field-shopping" type="checkbox" />
                <label class="form-checkbox-label" for="field-shopping"
                  >Shopping List Default</label
                >
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button class="btn-cancel" id="btn-cancel" type="button">Cancel</button>
            <button class="app-btn" id="btn-save" type="submit">Save</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Equipment modal overlay -->
    <div class="modal-overlay" id="modal-overlay-equip">
      <div
        class="modal-dialog modal-dialog-equipment"
        role="dialog"
        aria-labelledby="modal-title-equip"
      >
        <h2 class="modal-title" id="modal-title-equip">Add Equipment</h2>
        <form id="equipment-form" novalidate>
          <div class="form-grid">
            <div class="form-group full-width">
              <label class="form-label" for="eq-field-name">Name</label>
              <input
                class="form-input"
                id="eq-field-name"
                type="text"
                placeholder="e.g. Hawthorne Strainer"
                required
              />
              <span class="form-error" id="eq-error-name"></span>
            </div>

            <div class="form-group">
              <label class="form-label" for="eq-field-category">Category</label>
              <select class="form-select" id="eq-field-category" required>
                <option value="">Select&hellip;</option>
              </select>
              <span class="form-error" id="eq-error-category"></span>
            </div>

            <div class="form-group">
              <label class="form-label" for="eq-field-subcategory">Subcategory</label>
              <select class="form-select" id="eq-field-subcategory" required>
                <option value="">Select category first</option>
              </select>
              <span class="form-error" id="eq-error-subcategory"></span>
            </div>

            <div class="form-group">
              <label class="form-label" for="eq-field-quantity">Quantity</label>
              <input
                class="form-input"
                id="eq-field-quantity"
                type="number"
                min="0"
                step="1"
                value="1"
              />
              <span class="form-error" id="eq-error-quantity"></span>
            </div>

            <div class="form-group">
              <label class="form-label" for="eq-field-condition">Condition</label>
              <select class="form-select" id="eq-field-condition" required>
                <option value="">Select&hellip;</option>
                <option value="good">Good</option>
                <option value="fair">Fair</option>
                <option value="replace">Replace</option>
              </select>
              <span class="form-error" id="eq-error-condition"></span>
            </div>

            <div class="form-group full-width">
              <label class="form-label" for="eq-field-tags">Tags (comma-separated)</label>
              <input
                class="form-input"
                id="eq-field-tags"
                type="text"
                placeholder="e.g. stainless, cocktail, essential"
              />
            </div>

            <div class="form-group full-width">
              <label class="form-label" for="eq-field-notes">Notes</label>
              <textarea
                class="form-textarea"
                id="eq-field-notes"
                placeholder="Brand, material, size&hellip;"
                rows="2"
              ></textarea>
            </div>
          </div>

          <div class="form-actions">
            <button class="btn-cancel" id="btn-cancel-equip" type="button">Cancel</button>
            <button class="app-btn app-btn-equipment" id="btn-save-equip" type="submit">
              Save
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Amphora level popover -->
    <div class="amphora-popover" id="amphora-popover">
      <div class="amphora-popover-title">Bottle Level</div>
      <div class="amphora-level-options" id="amphora-level-options"></div>
    </div>

    <!-- Shared header component -->
    <script src="/js/components/app-header.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        firebase.auth().onAuthStateChanged(function (user) {
          if (!user) {
            window.location.href = '/';
            return;
          }

          // Render the shared header
          window.OlympusHeader.render('The Symposium');

          // Hide loading, show main content
          document.getElementById('app-loading').classList.add('hidden');
          document.getElementById('app-main').classList.remove('hidden');

          // Initialize the app
          initializeApp(user);
        });
      });

      function initializeApp() {
        var db = firebase.firestore();
        var serverTimestamp = firebase.firestore.FieldValue.serverTimestamp;

        // State
        var categoryMap = {};
        var ingredientCategoryMap = {};
        var equipmentCategoryMap = {};
        var allIngredients = [];
        var activeFilter = 'all';
        var searchQuery = '';
        var sortOption = 'category';
        var stockFilter = 'all';
        var editingId = null;
        var amphoraPopoverIng = null;

        // Equipment state
        var allEquipment = [];
        var equipActiveFilter = 'all';
        var equipSearchQuery = '';
        var equipSortOption = 'category';
        var conditionFilter = 'all';
        var equipEditingId = null;

        // DOM refs
        var listEl = document.getElementById('ingredient-list');
        var emptyEl = document.getElementById('empty-state');
        var countEl = document.getElementById('ingredient-count');
        var categoryGridEl = document.getElementById('category-grid');
        var oracleSearchEl = document.getElementById('oracle-search');
        var oracleClearEl = document.getElementById('oracle-clear');
        var sortSelectEl = document.getElementById('sort-select');
        var stockBtns = document.querySelectorAll('.stock-toggle-btn');
        var modalEl = document.getElementById('modal-overlay');
        var modalTitle = document.getElementById('modal-title');
        var formEl = document.getElementById('ingredient-form');
        var btnAdd = document.getElementById('btn-add');
        var btnCancel = document.getElementById('btn-cancel');
        var amphoraPopoverEl = document.getElementById('amphora-popover');
        var amphoraOptionsEl = document.getElementById('amphora-level-options');

        // View tab refs
        var tabIngredients = document.getElementById('tab-ingredients');
        var tabEquipment = document.getElementById('tab-equipment');
        var panelIngredients = document.getElementById('panel-ingredients');
        var panelEquipment = document.getElementById('panel-equipment');

        // Equipment panel refs
        var equipListEl = document.getElementById('equipment-list');
        var equipEmptyEl = document.getElementById('empty-state-equip');
        var equipCountEl = document.getElementById('equipment-count');
        var equipCategoryGridEl = document.getElementById('category-grid-equip');
        var equipSearchEl = document.getElementById('oracle-search-equip');
        var equipClearEl = document.getElementById('oracle-clear-equip');
        var equipSortSelectEl = document.getElementById('sort-select-equip');
        var condBtns = document.querySelectorAll('.condition-toggle-btn');

        // Equipment modal refs
        var equipModalEl = document.getElementById('modal-overlay-equip');
        var equipModalTitle = document.getElementById('modal-title-equip');
        var equipFormEl = document.getElementById('equipment-form');
        var btnAddEquip = document.getElementById('btn-add-equipment');
        var btnCancelEquip = document.getElementById('btn-cancel-equip');

        // Form fields
        var fieldName = document.getElementById('field-name');
        var fieldCategory = document.getElementById('field-category');
        var fieldSubcategory = document.getElementById('field-subcategory');
        var fieldUnit = document.getElementById('field-unit');
        var fieldQuantity = document.getElementById('field-quantity');
        var fieldInStock = document.getElementById('field-instock');
        var fieldTags = document.getElementById('field-tags');
        var fieldNotes = document.getElementById('field-notes');
        var fieldShopping = document.getElementById('field-shopping');
        var fieldThreshold = document.getElementById('field-threshold');

        // Equipment form fields
        var eqFieldName = document.getElementById('eq-field-name');
        var eqFieldCategory = document.getElementById('eq-field-category');
        var eqFieldSubcategory = document.getElementById('eq-field-subcategory');
        var eqFieldQuantity = document.getElementById('eq-field-quantity');
        var eqFieldCondition = document.getElementById('eq-field-condition');
        var eqFieldTags = document.getElementById('eq-field-tags');
        var eqFieldNotes = document.getElementById('eq-field-notes');

        // ── Amphora bottle-level constants ─────────────
        var BOTTLE_LEVELS = {
          full: { label: 'Full', fill: 1.0 },
          'three-quarter': { label: '3/4', fill: 0.75 },
          half: { label: 'Half', fill: 0.5 },
          quarter: { label: '1/4', fill: 0.25 },
          empty: { label: 'Empty', fill: 0.0 },
        };

        var LEVEL_ORDER = ['full', 'three-quarter', 'half', 'quarter', 'empty'];

        // ── Amphora SVG helper ────────────────────────
        function createAmphoraSVG(level, size) {
          var ns = 'http://www.w3.org/2000/svg';
          var fillPct = level && BOTTLE_LEVELS[level] ? BOTTLE_LEVELS[level].fill : -1;
          var isSealed = fillPct < 0;
          var w = size || 24;
          var h = Math.round(w * 1.4);
          var uid = Math.random().toString(36).substr(2, 6);

          var svg = document.createElementNS(ns, 'svg');
          svg.setAttribute('width', w);
          svg.setAttribute('height', h);
          svg.setAttribute('viewBox', '0 0 40 56');
          svg.setAttribute('aria-hidden', 'true');

          var defs = document.createElementNS(ns, 'defs');

          var clipPath = document.createElementNS(ns, 'clipPath');
          clipPath.setAttribute('id', 'bc-' + uid);

          var clipShape = document.createElementNS(ns, 'path');
          clipShape.setAttribute(
            'd',
            'M16,8 L16,14 C8,18 4,26 4,34 C4,44 10,52 20,52 C30,52 36,44 36,34 C36,26 32,18 24,14 L24,8 Z'
          );
          clipPath.appendChild(clipShape);
          defs.appendChild(clipPath);

          var grad = document.createElementNS(ns, 'linearGradient');
          grad.setAttribute('id', 'lg-' + uid);
          grad.setAttribute('x1', '0');
          grad.setAttribute('y1', '0');
          grad.setAttribute('x2', '0');
          grad.setAttribute('y2', '1');

          var stop1 = document.createElementNS(ns, 'stop');
          stop1.setAttribute('offset', '0%');
          stop1.setAttribute('stop-color', '#ffd54f');
          var stop2 = document.createElementNS(ns, 'stop');
          stop2.setAttribute('offset', '100%');
          stop2.setAttribute('stop-color', '#ff8a65');
          grad.appendChild(stop1);
          grad.appendChild(stop2);
          defs.appendChild(grad);

          svg.appendChild(defs);

          // Bottle outline
          var outline = document.createElementNS(ns, 'path');
          outline.setAttribute(
            'd',
            'M15,2 L25,2 L25,8 L24,8 L24,14 ' +
              'C32,18 38,26 38,34 C38,46 30,54 20,54 ' +
              'C10,54 2,46 2,34 C2,26 8,18 16,14 L16,8 L15,8 Z'
          );
          outline.setAttribute('fill', 'none');
          outline.setAttribute('stroke', isSealed ? '#37474f' : '#90a4ae');
          outline.setAttribute('stroke-width', '1.5');
          svg.appendChild(outline);

          // Handles
          var handleL = document.createElementNS(ns, 'path');
          handleL.setAttribute('d', 'M8,20 C-2,24 -2,38 8,42');
          handleL.setAttribute('fill', 'none');
          handleL.setAttribute('stroke', isSealed ? '#37474f' : '#90a4ae');
          handleL.setAttribute('stroke-width', '1.5');
          handleL.setAttribute('stroke-linecap', 'round');
          svg.appendChild(handleL);

          var handleR = document.createElementNS(ns, 'path');
          handleR.setAttribute('d', 'M32,20 C42,24 42,38 32,42');
          handleR.setAttribute('fill', 'none');
          handleR.setAttribute('stroke', isSealed ? '#37474f' : '#90a4ae');
          handleR.setAttribute('stroke-width', '1.5');
          handleR.setAttribute('stroke-linecap', 'round');
          svg.appendChild(handleR);

          // Liquid fill
          if (!isSealed && fillPct > 0) {
            var fillGroup = document.createElementNS(ns, 'g');
            fillGroup.setAttribute('clip-path', 'url(#bc-' + uid + ')');

            var fillHeight = 44 * fillPct;
            var fillY = 52 - fillHeight;

            var fillRect = document.createElementNS(ns, 'rect');
            fillRect.setAttribute('x', '0');
            fillRect.setAttribute('y', String(fillY));
            fillRect.setAttribute('width', '40');
            fillRect.setAttribute('height', String(fillHeight));
            fillRect.setAttribute('fill', 'url(#lg-' + uid + ')');
            fillRect.setAttribute('opacity', '0.85');
            fillGroup.appendChild(fillRect);

            svg.appendChild(fillGroup);
          }

          // Empty state: red X
          if (!isSealed && fillPct === 0) {
            var emptyLine1 = document.createElementNS(ns, 'line');
            emptyLine1.setAttribute('x1', '14');
            emptyLine1.setAttribute('y1', '28');
            emptyLine1.setAttribute('x2', '26');
            emptyLine1.setAttribute('y2', '40');
            emptyLine1.setAttribute('stroke', '#ef5350');
            emptyLine1.setAttribute('stroke-width', '1.5');
            emptyLine1.setAttribute('opacity', '0.6');
            svg.appendChild(emptyLine1);

            var emptyLine2 = document.createElementNS(ns, 'line');
            emptyLine2.setAttribute('x1', '26');
            emptyLine2.setAttribute('y1', '28');
            emptyLine2.setAttribute('x2', '14');
            emptyLine2.setAttribute('y2', '40');
            emptyLine2.setAttribute('stroke', '#ef5350');
            emptyLine2.setAttribute('stroke-width', '1.5');
            emptyLine2.setAttribute('opacity', '0.6');
            svg.appendChild(emptyLine2);
          }

          // Sealed state: cork cap
          if (isSealed) {
            var cork = document.createElementNS(ns, 'rect');
            cork.setAttribute('x', '14');
            cork.setAttribute('y', '0');
            cork.setAttribute('width', '12');
            cork.setAttribute('height', '6');
            cork.setAttribute('rx', '2');
            cork.setAttribute('fill', '#37474f');
            svg.appendChild(cork);
          }

          return svg;
        }

        // ── Load categories (one-time) ──────────────────
        function loadCategories() {
          return db
            .collection('symposium_categories')
            .orderBy('sortOrder')
            .get()
            .then(function (snapshot) {
              snapshot.forEach(function (doc) {
                categoryMap[doc.id] = doc.data();
              });
              // Split categories by type
              Object.keys(categoryMap).forEach(function (id) {
                if (categoryMap[id].type === 'equipment') {
                  equipmentCategoryMap[id] = categoryMap[id];
                } else {
                  ingredientCategoryMap[id] = categoryMap[id];
                }
              });
              populateCategorySelect();
              populateEquipCategorySelect();
              renderCategoryGrid();
              renderEquipCategoryGrid();
            });
        }

        function populateCategorySelect() {
          Object.keys(ingredientCategoryMap).forEach(function (id) {
            var opt = document.createElement('option');
            opt.value = id;
            opt.textContent = ingredientCategoryMap[id].name;
            fieldCategory.appendChild(opt);
          });
        }

        function populateEquipCategorySelect() {
          Object.keys(equipmentCategoryMap).forEach(function (id) {
            var opt = document.createElement('option');
            opt.value = id;
            opt.textContent = equipmentCategoryMap[id].name;
            eqFieldCategory.appendChild(opt);
          });
        }

        // ── Category browse grid ────────────────────────
        function renderCategoryGrid() {
          categoryGridEl.innerHTML = '';
          var allCard = makeCategoryCard('all', 'All', allIngredients.length, 'ingredients');
          categoryGridEl.appendChild(allCard);
          Object.keys(ingredientCategoryMap).forEach(function (id) {
            var count = allIngredients.filter(function (i) {
              return i.category === id;
            }).length;
            categoryGridEl.appendChild(
              makeCategoryCard(id, ingredientCategoryMap[id].name, count, 'ingredients')
            );
          });
        }

        function renderEquipCategoryGrid() {
          equipCategoryGridEl.innerHTML = '';
          var allCard = makeCategoryCard('all', 'All', allEquipment.length, 'equipment');
          equipCategoryGridEl.appendChild(allCard);
          Object.keys(equipmentCategoryMap).forEach(function (id) {
            var count = allEquipment.filter(function (e) {
              return e.category === id;
            }).length;
            equipCategoryGridEl.appendChild(
              makeCategoryCard(id, equipmentCategoryMap[id].name, count, 'equipment')
            );
          });
        }

        function makeCategoryCard(id, name, count, view) {
          var isActive = (view === 'equipment' ? equipActiveFilter : activeFilter) === id;
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'category-card' + (isActive ? ' active' : '');

          var countEl2 = document.createElement('span');
          countEl2.className = 'category-card-count';
          countEl2.textContent = count;

          var nameEl = document.createElement('span');
          nameEl.className = 'category-card-name';
          nameEl.textContent = name;

          btn.appendChild(countEl2);
          btn.appendChild(nameEl);

          btn.addEventListener('click', function () {
            if (view === 'equipment') {
              equipActiveFilter = id;
              renderEquipCategoryGrid();
              renderEquipList();
            } else {
              activeFilter = id;
              renderCategoryGrid();
              renderList();
            }
          });
          return btn;
        }

        // ── Subscribe to ingredients ────────────────────
        function subscribeToIngredients() {
          db.collection('symposium_ingredients')
            .orderBy('category')
            .orderBy('name')
            .onSnapshot(function (snapshot) {
              allIngredients = [];
              snapshot.forEach(function (doc) {
                allIngredients.push(Object.assign({ id: doc.id }, doc.data()));
              });
              renderCategoryGrid();
              renderList();
            });
        }

        // ── Subscribe to equipment ────────────────────
        function subscribeToEquipment() {
          db.collection('symposium_equipment')
            .orderBy('category')
            .orderBy('name')
            .onSnapshot(function (snapshot) {
              allEquipment = [];
              snapshot.forEach(function (doc) {
                allEquipment.push(Object.assign({ id: doc.id }, doc.data()));
              });
              renderEquipCategoryGrid();
              renderEquipList();
            });
        }

        // ── Shared list rendering helper ─────────────────
        function renderListSection(config) {
          var items = config.items;
          var targetListEl = config.listEl;
          var targetEmptyEl = config.emptyEl;
          var targetCountEl = config.countEl;
          var cardFn = config.renderCard;
          var getEmptyMessage = config.getEmptyMessage;
          var noun = config.noun || 'item';

          targetListEl.innerHTML = '';

          if (items.length === 0) {
            targetEmptyEl.classList.remove('hidden');
            targetCountEl.classList.add('hidden');
            targetEmptyEl.querySelector('.empty-state-text').textContent = getEmptyMessage();
            return;
          }

          targetEmptyEl.classList.add('hidden');
          targetCountEl.classList.remove('hidden');
          targetCountEl.textContent =
            items.length + (items.length === 1 ? ' ' + noun : ' ' + noun + 's');

          items.forEach(function (item) {
            targetListEl.appendChild(cardFn(item));
          });
        }

        // ── Render ingredient list ──────────────────────
        function renderList() {
          var result = allIngredients.slice();

          // 1. Category filter
          if (activeFilter !== 'all') {
            result = result.filter(function (ing) {
              return ing.category === activeFilter;
            });
          }

          // 2. Search filter — name, category name, or tags (case-insensitive)
          if (searchQuery) {
            var q = searchQuery.toLowerCase();
            result = result.filter(function (ing) {
              var catName = (
                categoryMap[ing.category] ? categoryMap[ing.category].name : ''
              ).toLowerCase();
              var tagHit =
                ing.tags &&
                ing.tags.some(function (t) {
                  return t.toLowerCase().includes(q);
                });
              return ing.name.toLowerCase().includes(q) || catName.includes(q) || tagHit;
            });
          }

          // 3. Stock filter
          if (stockFilter === 'in-stock') {
            result = result.filter(function (ing) {
              return ing.inStock;
            });
          } else if (stockFilter === 'out-of-stock') {
            result = result.filter(function (ing) {
              return !ing.inStock;
            });
          }

          // 4. Sort
          if (sortOption === 'alpha') {
            result.sort(function (a, b) {
              return a.name.localeCompare(b.name);
            });
          } else if (sortOption === 'stock') {
            result.sort(function (a, b) {
              if (a.inStock !== b.inStock) return a.inStock ? -1 : 1;
              return a.name.localeCompare(b.name);
            });
          }
          // 'category': Firestore already delivers category → name order

          renderListSection({
            items: result,
            listEl: listEl,
            emptyEl: emptyEl,
            countEl: countEl,
            renderCard: renderCard,
            noun: 'ingredient',
            getEmptyMessage: function () {
              if (searchQuery && activeFilter !== 'all') {
                return 'The Oracle finds nothing matching that name in this category.';
              } else if (searchQuery) {
                return 'The Oracle finds nothing by that name.';
              } else if (stockFilter === 'in-stock') {
                return activeFilter !== 'all'
                  ? 'No in-stock ingredients in this category.'
                  : 'No in-stock ingredients found.';
              } else if (stockFilter === 'out-of-stock') {
                return activeFilter !== 'all'
                  ? 'No out-of-stock ingredients in this category.'
                  : 'No out-of-stock ingredients found.';
              } else if (activeFilter !== 'all' && allIngredients.length > 0) {
                return 'No ingredients in this category yet.';
              }
              return 'The Cellar awaits its first offering.';
            },
          });
        }

        // ── Render a single ingredient card ─────────────
        function renderCard(ing) {
          var card = document.createElement('div');
          card.className = 'ingredient-card';

          var header = document.createElement('div');
          header.className = 'ingredient-card-header';

          var info = document.createElement('div');

          var name = document.createElement('h3');
          name.className = 'ingredient-name';
          name.textContent = ing.name;

          var meta = document.createElement('div');
          meta.className = 'ingredient-meta';

          var catBadge = document.createElement('span');
          catBadge.className = 'badge badge-category';
          catBadge.textContent = categoryMap[ing.category]
            ? categoryMap[ing.category].name
            : ing.category;
          meta.appendChild(catBadge);

          if (ing.subcategory) {
            var subBadge = document.createElement('span');
            subBadge.className = 'badge badge-subcategory';
            subBadge.textContent = ing.subcategory;
            meta.appendChild(subBadge);
          }

          var stockBadge = document.createElement('span');
          stockBadge.className =
            'badge badge-stock ' + (ing.inStock ? 'badge-in-stock' : 'badge-out-of-stock');
          stockBadge.textContent = ing.inStock ? 'In Stock' : 'Out of Stock';
          meta.appendChild(stockBadge);

          info.appendChild(name);
          info.appendChild(meta);

          var actions = document.createElement('div');
          actions.className = 'ingredient-actions';

          var editBtn = document.createElement('button');
          editBtn.type = 'button';
          editBtn.className = 'btn-icon btn-edit';
          editBtn.textContent = 'Edit';
          editBtn.addEventListener('click', function () {
            openModal(ing);
          });

          var deleteBtn = document.createElement('button');
          deleteBtn.type = 'button';
          deleteBtn.className = 'btn-icon btn-delete';
          deleteBtn.textContent = 'Delete';
          deleteBtn.addEventListener('click', function () {
            handleDelete(ing);
          });

          actions.appendChild(editBtn);
          actions.appendChild(deleteBtn);

          // Amphora bottle level indicator
          var amphoraBtn = document.createElement('button');
          amphoraBtn.type = 'button';
          amphoraBtn.className =
            'amphora-indicator' + (!ing.openBottleLevel ? ' amphora-sealed' : '');
          amphoraBtn.title = ing.openBottleLevel
            ? 'Bottle level: ' + (BOTTLE_LEVELS[ing.openBottleLevel] || {}).label
            : 'No open bottle (sealed)';

          amphoraBtn.appendChild(createAmphoraSVG(ing.openBottleLevel, 24));

          var amphoraLabelEl = document.createElement('span');
          amphoraLabelEl.className = 'amphora-label';
          amphoraLabelEl.textContent = ing.openBottleLevel
            ? (BOTTLE_LEVELS[ing.openBottleLevel] || {}).label || '?'
            : 'Sealed';
          amphoraBtn.appendChild(amphoraLabelEl);

          amphoraBtn.addEventListener('click', function (e) {
            e.stopPropagation();
            openAmphoraPopover(ing, amphoraBtn);
          });

          header.appendChild(info);
          header.appendChild(amphoraBtn);
          header.appendChild(actions);
          card.appendChild(header);

          // Details row
          var details = document.createElement('div');
          details.className = 'ingredient-details';

          var qtyDetail = document.createElement('span');
          qtyDetail.innerHTML =
            '<span class="ingredient-detail-label">Qty:</span> ' +
            (ing.quantity || 0) +
            ' ' +
            (ing.unit || '');
          details.appendChild(qtyDetail);

          if (ing.lowStockThreshold > 0) {
            var threshDetail = document.createElement('span');
            threshDetail.innerHTML =
              '<span class="ingredient-detail-label">Low at:</span> ' +
              ing.lowStockThreshold +
              ' ' +
              (ing.unit || '');
            details.appendChild(threshDetail);
          }

          card.appendChild(details);

          if (ing.tags && Array.isArray(ing.tags) && ing.tags.length > 0) {
            var tagsRow = document.createElement('div');
            tagsRow.className = 'ingredient-meta';
            tagsRow.style.marginTop = '0.5rem';
            ing.tags.forEach(function (tag) {
              var tagBadge = document.createElement('span');
              tagBadge.className = 'badge badge-subcategory';
              tagBadge.textContent = tag;
              tagsRow.appendChild(tagBadge);
            });
            card.appendChild(tagsRow);
          }

          if (ing.notes) {
            var notes = document.createElement('div');
            notes.className = 'ingredient-notes';
            notes.textContent = ing.notes;
            card.appendChild(notes);
          }

          return card;
        }

        // ── Modal open / close ──────────────────────────
        function openModal(ingredient) {
          editingId = ingredient ? ingredient.id : null;
          modalTitle.textContent = ingredient ? 'Edit Ingredient' : 'Add Ingredient';

          clearErrors();

          if (ingredient) {
            fieldName.value = ingredient.name || '';
            fieldCategory.value = ingredient.category || '';
            populateSubcategories(ingredient.category);
            fieldSubcategory.value = ingredient.subcategory || '';
            fieldUnit.value = ingredient.unit || '';
            fieldQuantity.value = ingredient.quantity != null ? ingredient.quantity : 0;
            fieldInStock.checked = !!ingredient.inStock;
            fieldTags.value =
              ingredient.tags && Array.isArray(ingredient.tags) ? ingredient.tags.join(', ') : '';
            fieldNotes.value = ingredient.notes || '';
            fieldShopping.checked = !!ingredient.shoppingListDefault;
            fieldThreshold.value =
              ingredient.lowStockThreshold != null ? ingredient.lowStockThreshold : 0;
          } else {
            formEl.reset();
            fieldQuantity.value = '0';
            fieldThreshold.value = '0';
            fieldSubcategory.innerHTML = '<option value="">Select category first</option>';
          }

          modalEl.classList.add('open');
          fieldName.focus();
        }

        function closeModal() {
          modalEl.classList.remove('open');
          editingId = null;
        }

        // ── Subcategory cascade ─────────────────────────
        function populateSubcategoryDropdown(categoryId, dropdownEl) {
          dropdownEl.innerHTML = '<option value="">Select&hellip;</option>';
          var cat = categoryMap[categoryId];
          if (cat && cat.subcategories) {
            cat.subcategories.forEach(function (sub) {
              var opt = document.createElement('option');
              opt.value = sub;
              opt.textContent = sub.charAt(0).toUpperCase() + sub.slice(1);
              dropdownEl.appendChild(opt);
            });
          }
        }

        function populateSubcategories(categoryId) {
          populateSubcategoryDropdown(categoryId, fieldSubcategory);
        }

        // ── Validation ──────────────────────────────────
        function clearErrors() {
          var errors = formEl.querySelectorAll('.form-error');
          errors.forEach(function (el) {
            el.textContent = '';
          });
        }

        function setError(fieldId, msg) {
          var el = document.getElementById('error-' + fieldId);
          if (el) el.textContent = msg;
        }

        function validateForm() {
          clearErrors();
          var valid = true;

          if (!fieldName.value.trim()) {
            setError('name', 'Name is required');
            valid = false;
          }
          if (!fieldCategory.value) {
            setError('category', 'Category is required');
            valid = false;
          }
          if (!fieldSubcategory.value) {
            setError('subcategory', 'Subcategory is required');
            valid = false;
          }
          if (!fieldUnit.value) {
            setError('unit', 'Unit is required');
            valid = false;
          }
          if (fieldQuantity.value === '' || parseFloat(fieldQuantity.value) < 0) {
            setError('quantity', 'Quantity must be 0 or greater');
            valid = false;
          }

          return valid;
        }

        // ── Duplicate check ─────────────────────────────
        function checkDuplicate(name, category) {
          var trimmed = name.trim().toLowerCase();
          return allIngredients.some(function (ing) {
            return (
              ing.id !== editingId &&
              ing.name.toLowerCase() === trimmed &&
              ing.category === category
            );
          });
        }

        // ── Form submit ─────────────────────────────────
        function handleSubmit(e) {
          e.preventDefault();
          if (!validateForm()) return;

          var name = fieldName.value.trim();
          var category = fieldCategory.value;

          if (checkDuplicate(name, category)) {
            setError('name', 'An ingredient with this name already exists in this category');
            return;
          }

          var tags = fieldTags.value
            .split(',')
            .map(function (t) {
              return t.trim();
            })
            .filter(Boolean);

          var data = {
            name: name,
            category: category,
            subcategory: fieldSubcategory.value,
            tags: tags,
            unit: fieldUnit.value,
            type: 'consumable',
            inStock: fieldInStock.checked,
            quantity: parseFloat(fieldQuantity.value) || 0,
            notes: fieldNotes.value.trim(),
            shoppingListDefault: fieldShopping.checked,
            lowStockThreshold: parseFloat(fieldThreshold.value) || 0,
            updatedAt: serverTimestamp(),
          };

          var btnSave = document.getElementById('btn-save');
          btnSave.disabled = true;
          btnSave.textContent = 'Saving\u2026';

          var promise;
          if (editingId) {
            var existingIng = allIngredients.find(function (ing) {
              return ing.id === editingId;
            });
            data.createdAt = existingIng.createdAt;
            if (existingIng.openBottleLevel) {
              data.openBottleLevel = existingIng.openBottleLevel;
            }
            promise = db.collection('symposium_ingredients').doc(editingId).set(data);
          } else {
            data.createdAt = serverTimestamp();
            promise = db.collection('symposium_ingredients').add(data);
          }

          promise
            .then(function () {
              closeModal();
            })
            .catch(function (err) {
              console.error('Failed to save ingredient:', err);
              setError('name', 'Failed to save. Check console for details.');
            })
            .finally(function () {
              btnSave.disabled = false;
              btnSave.textContent = 'Save';
            });
        }

        // ── Delete ──────────────────────────────────────
        function handleDelete(ing) {
          if (!window.confirm('Remove "' + ing.name + '" from the cellar?')) {
            return;
          }

          db.collection('symposium_ingredients')
            .doc(ing.id)
            .delete()
            .catch(function (err) {
              console.error('Failed to delete ingredient:', err);
            });
        }

        // ── Render equipment list ──────────────────────
        function renderEquipList() {
          var result = allEquipment.slice();

          // 1. Category filter
          if (equipActiveFilter !== 'all') {
            result = result.filter(function (eq) {
              return eq.category === equipActiveFilter;
            });
          }

          // 2. Search filter
          if (equipSearchQuery) {
            var q = equipSearchQuery.toLowerCase();
            result = result.filter(function (eq) {
              var catName = (
                categoryMap[eq.category] ? categoryMap[eq.category].name : ''
              ).toLowerCase();
              var tagHit =
                eq.tags &&
                eq.tags.some(function (t) {
                  return t.toLowerCase().includes(q);
                });
              return eq.name.toLowerCase().includes(q) || catName.includes(q) || tagHit;
            });
          }

          // 3. Condition filter
          if (conditionFilter !== 'all') {
            result = result.filter(function (eq) {
              return eq.condition === conditionFilter;
            });
          }

          // 4. Sort
          if (equipSortOption === 'alpha') {
            result.sort(function (a, b) {
              return a.name.localeCompare(b.name);
            });
          } else if (equipSortOption === 'condition') {
            var condOrder = { replace: 0, fair: 1, good: 2 };
            result.sort(function (a, b) {
              var orderA = Object.prototype.hasOwnProperty.call(condOrder, a.condition)
                ? condOrder[a.condition]
                : 3;
              var orderB = Object.prototype.hasOwnProperty.call(condOrder, b.condition)
                ? condOrder[b.condition]
                : 3;
              var diff = orderA - orderB;
              return diff !== 0 ? diff : a.name.localeCompare(b.name);
            });
          }

          renderListSection({
            items: result,
            listEl: equipListEl,
            emptyEl: equipEmptyEl,
            countEl: equipCountEl,
            renderCard: renderEquipCard,
            noun: 'item',
            getEmptyMessage: function () {
              if (equipSearchQuery && equipActiveFilter !== 'all') {
                return 'No equipment matches that search in this category.';
              } else if (equipSearchQuery) {
                return 'No equipment matches that search.';
              } else if (conditionFilter !== 'all') {
                return (
                  'No equipment with \u201c' +
                  conditionFilter +
                  '\u201d condition' +
                  (equipActiveFilter !== 'all' ? ' in this category.' : '.')
                );
              } else if (equipActiveFilter !== 'all' && allEquipment.length > 0) {
                return 'No equipment in this category yet.';
              }
              return 'The Workshop awaits its first tool.';
            },
          });
        }

        // ── Render a single equipment card ─────────────
        function renderEquipCard(eq) {
          var card = document.createElement('div');
          card.className = 'equipment-card';

          var header = document.createElement('div');
          header.className = 'ingredient-card-header';

          var info = document.createElement('div');

          var name = document.createElement('h3');
          name.className = 'ingredient-name';
          name.textContent = eq.name;

          var meta = document.createElement('div');
          meta.className = 'ingredient-meta';

          var catBadge = document.createElement('span');
          catBadge.className = 'badge badge-category';
          catBadge.textContent = categoryMap[eq.category]
            ? categoryMap[eq.category].name
            : eq.category;
          meta.appendChild(catBadge);

          if (eq.subcategory) {
            var subBadge = document.createElement('span');
            subBadge.className = 'badge badge-subcategory';
            subBadge.textContent = eq.subcategory;
            meta.appendChild(subBadge);
          }

          var allowedConditions = ['good', 'fair', 'replace'];
          var condition =
            typeof eq.condition === 'string' && allowedConditions.indexOf(eq.condition) !== -1
              ? eq.condition
              : 'good';
          var condBadge = document.createElement('span');
          condBadge.className = 'badge badge-condition badge-condition-' + condition;
          condBadge.textContent = condition.charAt(0).toUpperCase() + condition.slice(1);
          meta.appendChild(condBadge);

          info.appendChild(name);
          info.appendChild(meta);

          var actions = document.createElement('div');
          actions.className = 'ingredient-actions';

          var editBtn = document.createElement('button');
          editBtn.type = 'button';
          editBtn.className = 'btn-icon btn-edit';
          editBtn.textContent = 'Edit';
          editBtn.addEventListener('click', function () {
            openEquipModal(eq);
          });

          var deleteBtn = document.createElement('button');
          deleteBtn.type = 'button';
          deleteBtn.className = 'btn-icon btn-delete';
          deleteBtn.textContent = 'Delete';
          deleteBtn.addEventListener('click', function () {
            handleEquipDelete(eq);
          });

          actions.appendChild(editBtn);
          actions.appendChild(deleteBtn);

          header.appendChild(info);
          header.appendChild(actions);
          card.appendChild(header);

          // Details row
          var details = document.createElement('div');
          details.className = 'ingredient-details';
          var qtyDetail = document.createElement('span');
          var qtyLabel = document.createElement('span');
          qtyLabel.className = 'ingredient-detail-label';
          qtyLabel.textContent = 'Qty:';
          qtyDetail.appendChild(qtyLabel);
          qtyDetail.appendChild(document.createTextNode(' ' + (eq.quantity || 0)));
          details.appendChild(qtyDetail);
          card.appendChild(details);

          // Tags
          if (eq.tags && Array.isArray(eq.tags) && eq.tags.length > 0) {
            var tagsRow = document.createElement('div');
            tagsRow.className = 'ingredient-meta';
            tagsRow.style.marginTop = '0.5rem';
            eq.tags.forEach(function (tag) {
              var tagBadge = document.createElement('span');
              tagBadge.className = 'badge badge-subcategory';
              tagBadge.textContent = tag;
              tagsRow.appendChild(tagBadge);
            });
            card.appendChild(tagsRow);
          }

          // Notes
          if (eq.notes) {
            var notes = document.createElement('div');
            notes.className = 'ingredient-notes';
            notes.textContent = eq.notes;
            card.appendChild(notes);
          }

          return card;
        }

        // ── Equipment modal open / close ──────────────
        function openEquipModal(equipment) {
          equipEditingId = equipment ? equipment.id : null;
          equipModalTitle.textContent = equipment ? 'Edit Equipment' : 'Add Equipment';

          clearEquipErrors();

          if (equipment) {
            eqFieldName.value = equipment.name || '';
            eqFieldCategory.value = equipment.category || '';
            populateEquipSubcategories(equipment.category);
            eqFieldSubcategory.value = equipment.subcategory || '';
            eqFieldQuantity.value = equipment.quantity != null ? equipment.quantity : 1;
            eqFieldCondition.value = equipment.condition || '';
            eqFieldTags.value =
              equipment.tags && Array.isArray(equipment.tags) ? equipment.tags.join(', ') : '';
            eqFieldNotes.value = equipment.notes || '';
          } else {
            equipFormEl.reset();
            eqFieldQuantity.value = '1';
            eqFieldSubcategory.innerHTML = '<option value="">Select category first</option>';
          }

          equipModalEl.classList.add('open');
          eqFieldName.focus();
        }

        function closeEquipModal() {
          equipModalEl.classList.remove('open');
          equipEditingId = null;
        }

        // ── Equipment subcategory cascade ──────────────
        function populateEquipSubcategories(categoryId) {
          populateSubcategoryDropdown(categoryId, eqFieldSubcategory);
        }

        // ── Equipment validation ──────────────────────
        function clearEquipErrors() {
          var errors = equipFormEl.querySelectorAll('.form-error');
          errors.forEach(function (el) {
            el.textContent = '';
          });
        }

        function setEquipError(fieldId, msg) {
          var el = document.getElementById('eq-error-' + fieldId);
          if (el) el.textContent = msg;
        }

        function validateEquipForm() {
          clearEquipErrors();
          var valid = true;

          if (!eqFieldName.value.trim()) {
            setEquipError('name', 'Name is required');
            valid = false;
          }
          if (!eqFieldCategory.value) {
            setEquipError('category', 'Category is required');
            valid = false;
          }
          if (!eqFieldSubcategory.value) {
            setEquipError('subcategory', 'Subcategory is required');
            valid = false;
          }
          if (eqFieldQuantity.value === '' || parseInt(eqFieldQuantity.value, 10) < 0) {
            setEquipError('quantity', 'Quantity must be 0 or greater');
            valid = false;
          }
          if (!eqFieldCondition.value) {
            setEquipError('condition', 'Condition is required');
            valid = false;
          }

          return valid;
        }

        // ── Equipment duplicate check ─────────────────
        function checkEquipDuplicate(name, category) {
          var trimmed = name.trim().toLowerCase();
          return allEquipment.some(function (eq) {
            return (
              eq.id !== equipEditingId &&
              eq.name.toLowerCase() === trimmed &&
              eq.category === category
            );
          });
        }

        // ── Equipment form submit ─────────────────────
        function handleEquipSubmit(e) {
          e.preventDefault();
          if (!validateEquipForm()) return;

          var name = eqFieldName.value.trim();
          var category = eqFieldCategory.value;

          if (checkEquipDuplicate(name, category)) {
            setEquipError('name', 'Equipment with this name already exists in this category');
            return;
          }

          var tags = eqFieldTags.value
            .split(',')
            .map(function (t) {
              return t.trim();
            })
            .filter(Boolean);

          var data = {
            name: name,
            category: category,
            subcategory: eqFieldSubcategory.value,
            tags: tags,
            type: 'reusable',
            quantity: parseInt(eqFieldQuantity.value, 10) || 0,
            condition: eqFieldCondition.value,
            notes: eqFieldNotes.value.trim(),
            updatedAt: serverTimestamp(),
          };

          var btnSave = document.getElementById('btn-save-equip');
          btnSave.disabled = true;
          btnSave.textContent = 'Saving\u2026';

          var promise;
          if (equipEditingId) {
            var existingEq = allEquipment.find(function (eq) {
              return eq.id === equipEditingId;
            });
            data.createdAt = (existingEq && existingEq.createdAt) || serverTimestamp();
            promise = db.collection('symposium_equipment').doc(equipEditingId).set(data);
          } else {
            data.createdAt = serverTimestamp();
            promise = db.collection('symposium_equipment').add(data);
          }

          promise
            .then(function () {
              closeEquipModal();
            })
            .catch(function (err) {
              console.error('Failed to save equipment:', err);
              setEquipError('name', 'Failed to save. Check console for details.');
            })
            .finally(function () {
              btnSave.disabled = false;
              btnSave.textContent = 'Save';
            });
        }

        // ── Equipment delete ──────────────────────────
        function handleEquipDelete(eq) {
          if (!window.confirm('Remove "' + eq.name + '" from the workshop?')) {
            return;
          }

          db.collection('symposium_equipment')
            .doc(eq.id)
            .delete()
            .catch(function (err) {
              console.error('Failed to delete equipment:', err);
            });
        }

        // ── View tab switching ────────────────────────
        function switchView(view) {
          tabIngredients.classList.toggle('active', view === 'ingredients');
          tabIngredients.setAttribute('aria-selected', view === 'ingredients' ? 'true' : 'false');
          tabEquipment.classList.toggle('active', view === 'equipment');
          tabEquipment.setAttribute('aria-selected', view === 'equipment' ? 'true' : 'false');

          panelIngredients.classList.toggle('hidden', view !== 'ingredients');
          panelEquipment.classList.toggle('hidden', view !== 'equipment');
        }

        // ── Amphora popover ────────────────────────────
        function openAmphoraPopover(ing, anchorEl) {
          if (
            amphoraPopoverIng &&
            amphoraPopoverIng.id === ing.id &&
            amphoraPopoverEl.classList.contains('open')
          ) {
            closeAmphoraPopover();
            return;
          }

          amphoraPopoverIng = ing;
          renderAmphoraOptions(ing);

          var rect = anchorEl.getBoundingClientRect();
          var popW = 220;
          var left = rect.left + rect.width / 2 - popW / 2;
          var top = rect.bottom + 8;

          if (left < 8) left = 8;
          if (left + popW > window.innerWidth - 8) left = window.innerWidth - 8 - popW;
          if (top + 300 > window.innerHeight) {
            top = rect.top - 8 - 300;
            if (top < 8) top = 8;
          }

          amphoraPopoverEl.style.left = left + 'px';
          amphoraPopoverEl.style.top = top + 'px';
          amphoraPopoverEl.classList.add('open');
        }

        function closeAmphoraPopover() {
          amphoraPopoverEl.classList.remove('open');
          amphoraPopoverIng = null;
        }

        function renderAmphoraOptions(ing) {
          amphoraOptionsEl.innerHTML = '';

          LEVEL_ORDER.forEach(function (levelKey) {
            var levelInfo = BOTTLE_LEVELS[levelKey];
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className =
              'amphora-level-btn' + (ing.openBottleLevel === levelKey ? ' active' : '');

            btn.appendChild(createAmphoraSVG(levelKey, 18));

            var labelSpan = document.createElement('span');
            labelSpan.textContent = levelInfo.label;
            btn.appendChild(labelSpan);

            btn.addEventListener('click', function () {
              handleAmphoraLevelChange(ing, levelKey);
            });

            amphoraOptionsEl.appendChild(btn);
          });

          var divider = document.createElement('div');
          divider.className = 'amphora-level-divider';
          amphoraOptionsEl.appendChild(divider);

          var sealedBtn = document.createElement('button');
          sealedBtn.type = 'button';
          sealedBtn.className =
            'amphora-level-btn amphora-sealed-btn' + (!ing.openBottleLevel ? ' active' : '');

          sealedBtn.appendChild(createAmphoraSVG(null, 18));

          var sealedLabel = document.createElement('span');
          sealedLabel.textContent = 'Sealed (no open bottle)';
          sealedBtn.appendChild(sealedLabel);

          sealedBtn.addEventListener('click', function () {
            handleAmphoraLevelChange(ing, null);
          });

          amphoraOptionsEl.appendChild(sealedBtn);
        }

        // ── Amphora level change ──────────────────────
        function handleAmphoraLevelChange(ing, newLevel) {
          var oldLevel = ing.openBottleLevel || null;

          if (newLevel === oldLevel) {
            closeAmphoraPopover();
            return;
          }

          // Optimistic UI update
          var localIng = allIngredients.find(function (i) {
            return i.id === ing.id;
          });
          if (localIng) {
            if (newLevel) {
              localIng.openBottleLevel = newLevel;
            } else {
              delete localIng.openBottleLevel;
            }
          }

          renderList();
          closeAmphoraPopover();

          // Prompt on empty
          var setShoppingList = false;
          if (newLevel === 'empty') {
            if (window.confirm('Bottle empty! Move "' + ing.name + '" to the shopping list?')) {
              setShoppingList = true;
              if (localIng) localIng.shoppingListDefault = true;
            }
          }

          // Build full document for .set()
          var currentDoc = allIngredients.find(function (i) {
            return i.id === ing.id;
          });
          if (!currentDoc) return;

          var data = {
            name: currentDoc.name,
            category: currentDoc.category,
            subcategory: currentDoc.subcategory,
            tags: currentDoc.tags || [],
            unit: currentDoc.unit,
            type: 'consumable',
            inStock: currentDoc.inStock,
            quantity: currentDoc.quantity || 0,
            notes: currentDoc.notes || '',
            shoppingListDefault: setShoppingList ? true : currentDoc.shoppingListDefault,
            lowStockThreshold: currentDoc.lowStockThreshold || 0,
            createdAt: currentDoc.createdAt,
            updatedAt: serverTimestamp(),
          };

          if (newLevel) {
            data.openBottleLevel = newLevel;
          }

          db.collection('symposium_ingredients')
            .doc(ing.id)
            .set(data)
            .catch(function (err) {
              console.error('Failed to update bottle level:', err);
              if (localIng) {
                if (oldLevel) {
                  localIng.openBottleLevel = oldLevel;
                } else {
                  delete localIng.openBottleLevel;
                }
              }
              renderList();
            });
        }

        // ── Event listeners ─────────────────────────────

        // Oracle search
        oracleSearchEl.addEventListener('input', function () {
          searchQuery = oracleSearchEl.value.trim();
          oracleClearEl.classList.toggle('hidden', searchQuery === '');
          renderList();
        });

        oracleClearEl.addEventListener('click', function () {
          oracleSearchEl.value = '';
          searchQuery = '';
          oracleClearEl.classList.add('hidden');
          renderList();
        });

        // Sort select
        sortSelectEl.addEventListener('change', function () {
          sortOption = sortSelectEl.value;
          renderList();
        });

        // Stock filter toggle
        stockBtns.forEach(function (btn) {
          btn.addEventListener('click', function () {
            stockFilter = btn.dataset.filter;
            stockBtns.forEach(function (b) {
              b.classList.toggle('active', b === btn);
            });
            renderList();
          });
        });

        btnAdd.addEventListener('click', function () {
          openModal(null);
        });

        btnCancel.addEventListener('click', closeModal);

        modalEl.addEventListener('click', function (e) {
          if (e.target === modalEl) closeModal();
        });

        document.addEventListener('keydown', function (e) {
          if (e.key === 'Escape') {
            if (amphoraPopoverEl.classList.contains('open')) {
              closeAmphoraPopover();
            } else if (modalEl.classList.contains('open')) {
              closeModal();
            } else if (equipModalEl.classList.contains('open')) {
              closeEquipModal();
            }
          }
        });

        document.addEventListener('click', function (e) {
          if (
            amphoraPopoverEl.classList.contains('open') &&
            !amphoraPopoverEl.contains(e.target) &&
            !e.target.closest('.amphora-indicator')
          ) {
            closeAmphoraPopover();
          }
        });

        window.addEventListener(
          'scroll',
          function () {
            if (amphoraPopoverEl.classList.contains('open')) {
              closeAmphoraPopover();
            }
          },
          true
        );

        window.addEventListener('resize', function () {
          if (amphoraPopoverEl.classList.contains('open')) {
            closeAmphoraPopover();
          }
        });

        fieldCategory.addEventListener('change', function () {
          populateSubcategories(fieldCategory.value);
        });

        formEl.addEventListener('submit', handleSubmit);

        // ── View tab switching ───────────────────────────
        tabIngredients.addEventListener('click', function () {
          switchView('ingredients');
        });
        tabEquipment.addEventListener('click', function () {
          switchView('equipment');
        });

        // ── Equipment search ─────────────────────────────
        equipSearchEl.addEventListener('input', function () {
          equipSearchQuery = equipSearchEl.value.trim();
          equipClearEl.classList.toggle('hidden', equipSearchQuery === '');
          renderEquipList();
        });

        equipClearEl.addEventListener('click', function () {
          equipSearchEl.value = '';
          equipSearchQuery = '';
          equipClearEl.classList.add('hidden');
          renderEquipList();
        });

        // ── Equipment sort ───────────────────────────────
        equipSortSelectEl.addEventListener('change', function () {
          equipSortOption = equipSortSelectEl.value;
          renderEquipList();
        });

        // ── Condition filter toggle ──────────────────────
        condBtns.forEach(function (btn) {
          btn.addEventListener('click', function () {
            conditionFilter = btn.dataset.filter;
            condBtns.forEach(function (b) {
              b.classList.toggle('active', b === btn);
            });
            renderEquipList();
          });
        });

        // ── Equipment add/modal ──────────────────────────
        btnAddEquip.addEventListener('click', function () {
          openEquipModal(null);
        });

        btnCancelEquip.addEventListener('click', closeEquipModal);

        equipModalEl.addEventListener('click', function (e) {
          if (e.target === equipModalEl) closeEquipModal();
        });

        eqFieldCategory.addEventListener('change', function () {
          populateEquipSubcategories(eqFieldCategory.value);
        });

        equipFormEl.addEventListener('submit', handleEquipSubmit);

        // ── Init ────────────────────────────────────────
        loadCategories()
          .then(function () {
            subscribeToIngredients();
            subscribeToEquipment();
          })
          .catch(function (err) {
            console.error('Failed to load categories:', err);
          });
      }
    </script>
  </body>
</html>
