<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>The Symposium — Olympus</title>

    <!-- Firebase SDK (compat) -->
    <script defer src="/__/firebase/12.9.0/firebase-app-compat.js"></script>
    <script defer src="/__/firebase/12.9.0/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/12.9.0/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>

    <!-- Shared Olympus styles -->
    <link rel="stylesheet" href="/styles/app.css" />

    <!-- App-specific styles -->
    <style>
      /* ── Toolbar ─────────────────────────────────────── */
      .toolbar {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 1.5rem;
      }

      /* ── Category filter chips ───────────────────────── */
      .filter-chips {
        display: flex;
        gap: 0.5rem;
        overflow-x: auto;
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
        -webkit-overflow-scrolling: touch;
      }

      .filter-chip {
        flex-shrink: 0;
        padding: 0.4rem 1rem;
        font-size: 0.8rem;
        font-family: inherit;
        color: #90a4ae;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 999px;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        transition:
          color 0.2s,
          background 0.2s,
          border-color 0.2s;
      }

      .filter-chip:hover {
        color: #e0e0e0;
        border-color: rgba(255, 183, 77, 0.3);
      }

      .filter-chip.active {
        color: #0a0e1a;
        background: linear-gradient(135deg, #ffd54f, #ffb74d);
        border-color: transparent;
      }

      /* ── Ingredient count ────────────────────────────── */
      .ingredient-count {
        text-align: center;
        font-size: 0.8rem;
        color: #546e7a;
        margin-bottom: 1.5rem;
        letter-spacing: 0.05em;
      }

      /* ── Ingredient cards ────────────────────────────── */
      .ingredient-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .ingredient-card {
        background: rgba(17, 24, 39, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 14px;
        padding: 1.25rem 1.5rem;
        transition: border-color 0.3s;
      }

      .ingredient-card:hover {
        border-color: rgba(255, 183, 77, 0.2);
      }

      .ingredient-card-header {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
      }

      .ingredient-card-header > div:first-child {
        flex: 1;
        min-width: 0;
      }

      .ingredient-name {
        font-size: 1.05rem;
        font-weight: 600;
        color: #e0e0e0;
        margin: 0;
      }

      .ingredient-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }

      .badge {
        display: inline-block;
        padding: 0.2rem 0.6rem;
        font-size: 0.7rem;
        border-radius: 999px;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }

      .badge-category {
        color: #ffb74d;
        background: rgba(255, 183, 77, 0.12);
        border: 1px solid rgba(255, 183, 77, 0.2);
      }

      .badge-subcategory {
        color: #90a4ae;
        background: rgba(144, 164, 174, 0.1);
        border: 1px solid rgba(144, 164, 174, 0.15);
      }

      .badge-stock {
        font-weight: 600;
      }

      .badge-in-stock {
        color: #66bb6a;
        background: rgba(102, 187, 106, 0.1);
        border: 1px solid rgba(102, 187, 106, 0.2);
      }

      .badge-out-of-stock {
        color: #ef5350;
        background: rgba(239, 83, 80, 0.1);
        border: 1px solid rgba(239, 83, 80, 0.2);
      }

      .ingredient-details {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 0.75rem;
        font-size: 0.85rem;
        color: #90a4ae;
      }

      .ingredient-detail-label {
        color: #546e7a;
      }

      .ingredient-notes {
        margin-top: 0.5rem;
        font-size: 0.85rem;
        color: #78909c;
        font-style: italic;
      }

      .ingredient-actions {
        display: flex;
        gap: 0.5rem;
        flex-shrink: 0;
      }

      .btn-icon {
        padding: 0.35rem 0.65rem;
        font-size: 0.7rem;
        font-family: inherit;
        color: #546e7a;
        background: none;
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 6px;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        transition:
          color 0.2s,
          border-color 0.2s;
      }

      .btn-edit:hover {
        color: #ffb74d;
        border-color: rgba(255, 183, 77, 0.3);
      }

      .btn-delete:hover {
        color: #ef5350;
        border-color: rgba(239, 83, 80, 0.3);
      }

      /* ── Empty state ─────────────────────────────────── */
      .empty-state {
        text-align: center;
        padding: 3rem 2rem;
      }

      .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 0.75rem;
        display: block;
        opacity: 0.5;
      }

      .empty-state-text {
        font-size: 0.95rem;
        color: #546e7a;
        font-style: italic;
        line-height: 1.6;
      }

      /* ── Modal ───────────────────────────────────────── */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 1rem;
        opacity: 0;
        visibility: hidden;
        transition:
          opacity 0.2s,
          visibility 0.2s;
      }

      .modal-overlay.open {
        opacity: 1;
        visibility: visible;
      }

      .modal-dialog {
        background: #111827;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        width: 100%;
        max-width: 520px;
        max-height: 90vh;
        overflow-y: auto;
        padding: 2rem;
      }

      .modal-title {
        font-size: 1.2rem;
        font-weight: 700;
        color: #e0e0e0;
        margin: 0 0 1.5rem;
      }

      /* ── Form ────────────────────────────────────────── */
      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
      }

      .form-group.full-width {
        grid-column: 1 / -1;
      }

      .form-label {
        font-size: 0.75rem;
        color: #90a4ae;
        text-transform: uppercase;
        letter-spacing: 0.06em;
      }

      .form-input,
      .form-select,
      .form-textarea {
        padding: 0.65rem 0.85rem;
        font-size: 0.9rem;
        font-family: inherit;
        color: #e0e0e0;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        outline: none;
        transition:
          border-color 0.2s,
          box-shadow 0.2s;
      }

      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        border-color: rgba(255, 183, 77, 0.5);
        box-shadow: 0 0 0 3px rgba(255, 183, 77, 0.1);
      }

      .form-input::placeholder,
      .form-textarea::placeholder {
        color: #4b5563;
        font-style: italic;
      }

      .form-select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2390a4ae' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        padding-right: 2rem;
      }

      .form-select option {
        background: #111827;
        color: #e0e0e0;
      }

      .form-textarea {
        resize: vertical;
        min-height: 60px;
      }

      .form-checkbox-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding-top: 0.25rem;
      }

      .form-checkbox {
        accent-color: #ffb74d;
        width: 16px;
        height: 16px;
      }

      .form-checkbox-label {
        font-size: 0.85rem;
        color: #e0e0e0;
      }

      .form-error {
        font-size: 0.75rem;
        color: #ef5350;
        min-height: 1em;
      }

      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        margin-top: 1.5rem;
      }

      .btn-cancel {
        padding: 0.6rem 1.2rem;
        font-size: 0.85rem;
        font-family: inherit;
        color: #90a4ae;
        background: none;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        cursor: pointer;
        transition:
          color 0.2s,
          border-color 0.2s;
      }

      .btn-cancel:hover {
        color: #e0e0e0;
        border-color: rgba(255, 255, 255, 0.2);
      }

      /* ── Amphora bottle level indicator ──────────── */
      .amphora-indicator {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.2rem;
        padding: 0.25rem 0.5rem;
        background: none;
        border: 1px solid transparent;
        border-radius: 8px;
        cursor: pointer;
        transition:
          border-color 0.2s,
          background 0.2s;
        flex-shrink: 0;
        font-family: inherit;
        color: inherit;
      }

      .amphora-indicator:hover {
        border-color: rgba(255, 183, 77, 0.3);
        background: rgba(255, 183, 77, 0.05);
      }

      .amphora-indicator:focus-visible {
        outline: 2px solid rgba(255, 183, 77, 0.7);
        outline-offset: 2px;
      }

      .amphora-label {
        font-size: 0.6rem;
        color: #546e7a;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        white-space: nowrap;
      }

      .amphora-indicator.amphora-sealed .amphora-label {
        color: #37474f;
      }

      /* ── Amphora level popover ───────────────────── */
      .amphora-popover {
        position: fixed;
        z-index: 1100;
        background: #111827;
        border: 1px solid rgba(255, 183, 77, 0.2);
        border-radius: 12px;
        padding: 1rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        min-width: 200px;
        opacity: 0;
        visibility: hidden;
        transition:
          opacity 0.15s,
          visibility 0.15s;
      }

      .amphora-popover.open {
        opacity: 1;
        visibility: visible;
      }

      .amphora-popover-title {
        font-size: 0.75rem;
        color: #90a4ae;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        margin-bottom: 0.75rem;
        text-align: center;
      }

      .amphora-level-options {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .amphora-level-btn {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
        font-family: inherit;
        color: #90a4ae;
        background: none;
        border: 1px solid transparent;
        border-radius: 8px;
        cursor: pointer;
        transition:
          color 0.2s,
          background 0.2s,
          border-color 0.2s;
        text-align: left;
        width: 100%;
      }

      .amphora-level-btn:hover {
        color: #e0e0e0;
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
      }

      .amphora-level-btn.active {
        color: #ffb74d;
        background: rgba(255, 183, 77, 0.08);
        border-color: rgba(255, 183, 77, 0.25);
      }

      .amphora-level-btn:focus-visible {
        outline: 2px solid rgba(255, 183, 77, 0.7);
        outline-offset: 2px;
      }

      .amphora-level-divider {
        height: 1px;
        background: rgba(255, 255, 255, 0.06);
        margin: 0.35rem 0;
      }

      .amphora-sealed-btn {
        color: #546e7a;
        font-style: italic;
      }

      /* ── Oracle search bar ──────────────────────────── */
      .oracle-search-wrap {
        flex: 1;
        position: relative;
        display: flex;
        align-items: center;
        min-width: 0;
      }

      .oracle-search-icon {
        position: absolute;
        left: 0.85rem;
        font-size: 0.9rem;
        color: #546e7a;
        pointer-events: none;
      }

      .oracle-search-input {
        width: 100%;
        padding: 0.65rem 2.5rem 0.65rem 2.5rem;
        font-size: 0.9rem;
        font-family: inherit;
        color: #e0e0e0;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        outline: none;
        transition:
          border-color 0.2s,
          box-shadow 0.2s;
      }

      .oracle-search-input::placeholder {
        color: #4b5563;
        font-style: italic;
      }

      .oracle-search-input:focus {
        border-color: rgba(255, 183, 77, 0.5);
        box-shadow: 0 0 0 3px rgba(255, 183, 77, 0.1);
      }

      .oracle-clear-btn {
        position: absolute;
        right: 0.5rem;
        background: none;
        border: none;
        color: #546e7a;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0.25rem 0.5rem;
        line-height: 1;
        font-family: inherit;
        transition: color 0.2s;
      }

      .oracle-clear-btn:hover {
        color: #e0e0e0;
      }

      /* ── Controls row (sort + stock filter) ─────────── */
      .controls-row {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
      }

      .sort-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .controls-label {
        font-size: 0.75rem;
        color: #546e7a;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        white-space: nowrap;
      }

      .controls-select {
        padding: 0.4rem 2rem 0.4rem 0.75rem;
        font-size: 0.8rem;
        min-width: 140px;
      }

      .stock-toggle {
        margin-left: auto;
      }

      .stock-toggle.active {
        color: #0a0e1a;
        background: linear-gradient(135deg, #66bb6a, #43a047);
        border-color: transparent;
      }

      /* ── Category browse grid ───────────────────────── */
      .category-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .category-card {
        background: rgba(17, 24, 39, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 14px;
        padding: 1.5rem 1.25rem;
        text-align: center;
        cursor: pointer;
        font-family: inherit;
        transition:
          border-color 0.3s,
          transform 0.2s,
          box-shadow 0.2s;
      }

      .category-card:hover {
        border-color: rgba(255, 183, 77, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(255, 183, 77, 0.1);
      }

      .category-card-name {
        font-size: 1rem;
        font-weight: 600;
        color: #e0e0e0;
        margin-bottom: 0.5rem;
      }

      .category-card-count {
        font-size: 0.8rem;
        color: #90a4ae;
      }

      .category-card-stock {
        font-size: 0.7rem;
        color: #546e7a;
        margin-top: 0.25rem;
      }

      @media (max-width: 600px) {
        .form-grid {
          grid-template-columns: 1fr;
        }

        .toolbar {
          flex-direction: column;
          gap: 0.75rem;
        }

        .oracle-search-wrap {
          width: 100%;
        }

        .toolbar .app-btn {
          width: 100%;
        }

        .ingredient-card-header {
          flex-direction: column;
        }

        .amphora-actions-row {
          display: flex;
          justify-content: space-between;
          align-items: center;
          align-self: stretch;
        }

        .ingredient-actions {
          align-self: flex-end;
        }

        .controls-row {
          flex-direction: column;
          align-items: stretch;
        }

        .stock-toggle {
          margin-left: 0;
          text-align: center;
        }

        .category-grid {
          grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        }

        .amphora-popover {
          left: 50% !important;
          transform: translateX(-50%);
          top: auto !important;
          bottom: 1rem;
          max-width: calc(100vw - 2rem);
        }
      }
    </style>
  </head>
  <body>
    <!-- Shared header — rendered by app-header.js -->
    <div id="appHeader"></div>

    <!-- Auth guard — shown while checking auth state -->
    <div class="app-loading" id="app-loading">
      <div class="app-spinner"></div>
      <p class="app-loading-text">Consulting the Oracle&hellip;</p>
    </div>

    <!-- Main content — hidden until authenticated -->
    <main class="app-main hidden" id="app-main">
      <h1 class="app-title">The Symposium</h1>
      <p class="app-subtitle">Where Dionysus keeps his ledger</p>
      <div class="app-divider"></div>

      <div class="toolbar">
        <div class="oracle-search-wrap">
          <span class="oracle-search-icon" aria-hidden="true">&#128270;</span>
          <input
            class="oracle-search-input"
            id="oracle-search"
            type="text"
            placeholder="Consult the Oracle&hellip;"
            aria-label="Search ingredients"
          />
          <button class="oracle-clear-btn hidden" id="oracle-clear" type="button" aria-label="Clear search">&times;</button>
        </div>
        <button class="app-btn" id="btn-add" type="button">+ Add Ingredient</button>
      </div>

      <div class="controls-row hidden" id="controls-row">
        <div class="sort-group">
          <label class="controls-label" for="sort-select">Sort</label>
          <select class="form-select controls-select" id="sort-select">
            <option value="category">Category</option>
            <option value="alpha">Alphabetical</option>
            <option value="stock">Stock Status</option>
          </select>
        </div>
        <button class="filter-chip stock-toggle" id="stock-toggle" type="button">In Stock Only</button>
      </div>

      <div class="filter-chips" id="filter-chips"></div>

      <div class="category-grid" id="category-grid"></div>

      <div class="ingredient-count hidden" id="ingredient-count"></div>

      <div class="ingredient-list" id="ingredient-list"></div>

      <div class="empty-state" id="empty-state">
        <span class="empty-state-icon" aria-hidden="true">&#127863;</span>
        <p class="empty-state-text">The Cellar awaits its first offering.</p>
      </div>
    </main>

    <!-- Modal overlay -->
    <div class="modal-overlay" id="modal-overlay">
      <div class="modal-dialog" role="dialog" aria-labelledby="modal-title">
        <h2 class="modal-title" id="modal-title">Add Ingredient</h2>
        <form id="ingredient-form" novalidate>
          <div class="form-grid">
            <div class="form-group full-width">
              <label class="form-label" for="field-name">Name</label>
              <input
                class="form-input"
                id="field-name"
                type="text"
                placeholder="e.g. Buffalo Trace"
                required
              />
              <span class="form-error" id="error-name"></span>
            </div>

            <div class="form-group">
              <label class="form-label" for="field-category">Category</label>
              <select class="form-select" id="field-category" required>
                <option value="">Select&hellip;</option>
              </select>
              <span class="form-error" id="error-category"></span>
            </div>

            <div class="form-group">
              <label class="form-label" for="field-subcategory">Subcategory</label>
              <select class="form-select" id="field-subcategory" required>
                <option value="">Select category first</option>
              </select>
              <span class="form-error" id="error-subcategory"></span>
            </div>

            <div class="form-group">
              <label class="form-label" for="field-unit">Unit</label>
              <select class="form-select" id="field-unit" required>
                <option value="">Select&hellip;</option>
                <option value="oz">oz</option>
                <option value="ml">ml</option>
                <option value="dash">dash</option>
                <option value="each">each</option>
                <option value="splash">splash</option>
              </select>
              <span class="form-error" id="error-unit"></span>
            </div>

            <div class="form-group">
              <label class="form-label" for="field-quantity">Quantity</label>
              <input
                class="form-input"
                id="field-quantity"
                type="number"
                min="0"
                step="0.25"
                value="0"
              />
              <span class="form-error" id="error-quantity"></span>
            </div>

            <div class="form-group">
              <div class="form-checkbox-row">
                <input class="form-checkbox" id="field-instock" type="checkbox" />
                <label class="form-checkbox-label" for="field-instock">In Stock</label>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="field-threshold">Low Stock Threshold</label>
              <input
                class="form-input"
                id="field-threshold"
                type="number"
                min="0"
                step="0.25"
                value="0"
              />
            </div>

            <div class="form-group full-width">
              <label class="form-label" for="field-tags">Tags (comma-separated)</label>
              <input
                class="form-input"
                id="field-tags"
                type="text"
                placeholder="e.g. bourbon, whiskey, american"
              />
            </div>

            <div class="form-group full-width">
              <label class="form-label" for="field-notes">Notes</label>
              <textarea
                class="form-textarea"
                id="field-notes"
                placeholder="Tasting notes, brand info&hellip;"
                rows="2"
              ></textarea>
            </div>

            <div class="form-group">
              <div class="form-checkbox-row">
                <input class="form-checkbox" id="field-shopping" type="checkbox" />
                <label class="form-checkbox-label" for="field-shopping"
                  >Shopping List Default</label
                >
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button class="btn-cancel" id="btn-cancel" type="button">Cancel</button>
            <button class="app-btn" id="btn-save" type="submit">Save</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Amphora level popover -->
    <div class="amphora-popover" id="amphora-popover">
      <div class="amphora-popover-title">Bottle Level</div>
      <div class="amphora-level-options" id="amphora-level-options"></div>
    </div>

    <!-- Shared header component -->
    <script src="/js/components/app-header.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        firebase.auth().onAuthStateChanged(function (user) {
          if (!user) {
            window.location.href = '/';
            return;
          }

          // Render the shared header
          window.OlympusHeader.render('The Symposium');

          // Hide loading, show main content
          document.getElementById('app-loading').classList.add('hidden');
          document.getElementById('app-main').classList.remove('hidden');

          // Initialize the app
          initializeApp(user);
        });
      });

      function initializeApp() {
        var db = firebase.firestore();
        var serverTimestamp = firebase.firestore.FieldValue.serverTimestamp;

        // State
        var categoryMap = {};
        var allIngredients = [];
        var activeFilter = 'all';
        var editingId = null;
        var amphoraPopoverIng = null;
        var searchQuery = '';
        var activeSort = 'category';
        var stockFilter = 'all';
        var searchTimer = null;

        // DOM refs
        var listEl = document.getElementById('ingredient-list');
        var emptyEl = document.getElementById('empty-state');
        var countEl = document.getElementById('ingredient-count');
        var chipsEl = document.getElementById('filter-chips');
        var modalEl = document.getElementById('modal-overlay');
        var modalTitle = document.getElementById('modal-title');
        var formEl = document.getElementById('ingredient-form');
        var btnAdd = document.getElementById('btn-add');
        var btnCancel = document.getElementById('btn-cancel');
        var amphoraPopoverEl = document.getElementById('amphora-popover');
        var amphoraOptionsEl = document.getElementById('amphora-level-options');
        var searchInput = document.getElementById('oracle-search');
        var searchClear = document.getElementById('oracle-clear');
        var sortSelect = document.getElementById('sort-select');
        var stockToggle = document.getElementById('stock-toggle');
        var controlsRow = document.getElementById('controls-row');
        var categoryGrid = document.getElementById('category-grid');

        // Form fields
        var fieldName = document.getElementById('field-name');
        var fieldCategory = document.getElementById('field-category');
        var fieldSubcategory = document.getElementById('field-subcategory');
        var fieldUnit = document.getElementById('field-unit');
        var fieldQuantity = document.getElementById('field-quantity');
        var fieldInStock = document.getElementById('field-instock');
        var fieldTags = document.getElementById('field-tags');
        var fieldNotes = document.getElementById('field-notes');
        var fieldShopping = document.getElementById('field-shopping');
        var fieldThreshold = document.getElementById('field-threshold');

        // ── Amphora bottle-level constants ─────────────
        var BOTTLE_LEVELS = {
          full: { label: 'Full', fill: 1.0 },
          'three-quarter': { label: '3/4', fill: 0.75 },
          half: { label: 'Half', fill: 0.5 },
          quarter: { label: '1/4', fill: 0.25 },
          empty: { label: 'Empty', fill: 0.0 },
        };

        var LEVEL_ORDER = ['full', 'three-quarter', 'half', 'quarter', 'empty'];

        // ── Amphora SVG helper ────────────────────────
        function createAmphoraSVG(level, size) {
          var ns = 'http://www.w3.org/2000/svg';
          var fillPct = level && BOTTLE_LEVELS[level] ? BOTTLE_LEVELS[level].fill : -1;
          var isSealed = fillPct < 0;
          var w = size || 24;
          var h = Math.round(w * 1.4);
          var uid = Math.random().toString(36).substr(2, 6);

          var svg = document.createElementNS(ns, 'svg');
          svg.setAttribute('width', w);
          svg.setAttribute('height', h);
          svg.setAttribute('viewBox', '0 0 40 56');
          svg.setAttribute('aria-hidden', 'true');

          var defs = document.createElementNS(ns, 'defs');

          var clipPath = document.createElementNS(ns, 'clipPath');
          clipPath.setAttribute('id', 'bc-' + uid);

          var clipShape = document.createElementNS(ns, 'path');
          clipShape.setAttribute(
            'd',
            'M16,8 L16,14 C8,18 4,26 4,34 C4,44 10,52 20,52 C30,52 36,44 36,34 C36,26 32,18 24,14 L24,8 Z'
          );
          clipPath.appendChild(clipShape);
          defs.appendChild(clipPath);

          var grad = document.createElementNS(ns, 'linearGradient');
          grad.setAttribute('id', 'lg-' + uid);
          grad.setAttribute('x1', '0');
          grad.setAttribute('y1', '0');
          grad.setAttribute('x2', '0');
          grad.setAttribute('y2', '1');

          var stop1 = document.createElementNS(ns, 'stop');
          stop1.setAttribute('offset', '0%');
          stop1.setAttribute('stop-color', '#ffd54f');
          var stop2 = document.createElementNS(ns, 'stop');
          stop2.setAttribute('offset', '100%');
          stop2.setAttribute('stop-color', '#ff8a65');
          grad.appendChild(stop1);
          grad.appendChild(stop2);
          defs.appendChild(grad);

          svg.appendChild(defs);

          // Bottle outline
          var outline = document.createElementNS(ns, 'path');
          outline.setAttribute(
            'd',
            'M15,2 L25,2 L25,8 L24,8 L24,14 ' +
              'C32,18 38,26 38,34 C38,46 30,54 20,54 ' +
              'C10,54 2,46 2,34 C2,26 8,18 16,14 L16,8 L15,8 Z'
          );
          outline.setAttribute('fill', 'none');
          outline.setAttribute('stroke', isSealed ? '#37474f' : '#90a4ae');
          outline.setAttribute('stroke-width', '1.5');
          svg.appendChild(outline);

          // Handles
          var handleL = document.createElementNS(ns, 'path');
          handleL.setAttribute('d', 'M8,20 C-2,24 -2,38 8,42');
          handleL.setAttribute('fill', 'none');
          handleL.setAttribute('stroke', isSealed ? '#37474f' : '#90a4ae');
          handleL.setAttribute('stroke-width', '1.5');
          handleL.setAttribute('stroke-linecap', 'round');
          svg.appendChild(handleL);

          var handleR = document.createElementNS(ns, 'path');
          handleR.setAttribute('d', 'M32,20 C42,24 42,38 32,42');
          handleR.setAttribute('fill', 'none');
          handleR.setAttribute('stroke', isSealed ? '#37474f' : '#90a4ae');
          handleR.setAttribute('stroke-width', '1.5');
          handleR.setAttribute('stroke-linecap', 'round');
          svg.appendChild(handleR);

          // Liquid fill
          if (!isSealed && fillPct > 0) {
            var fillGroup = document.createElementNS(ns, 'g');
            fillGroup.setAttribute('clip-path', 'url(#bc-' + uid + ')');

            var fillHeight = 44 * fillPct;
            var fillY = 52 - fillHeight;

            var fillRect = document.createElementNS(ns, 'rect');
            fillRect.setAttribute('x', '0');
            fillRect.setAttribute('y', String(fillY));
            fillRect.setAttribute('width', '40');
            fillRect.setAttribute('height', String(fillHeight));
            fillRect.setAttribute('fill', 'url(#lg-' + uid + ')');
            fillRect.setAttribute('opacity', '0.85');
            fillGroup.appendChild(fillRect);

            svg.appendChild(fillGroup);
          }

          // Empty state: red X
          if (!isSealed && fillPct === 0) {
            var emptyLine1 = document.createElementNS(ns, 'line');
            emptyLine1.setAttribute('x1', '14');
            emptyLine1.setAttribute('y1', '28');
            emptyLine1.setAttribute('x2', '26');
            emptyLine1.setAttribute('y2', '40');
            emptyLine1.setAttribute('stroke', '#ef5350');
            emptyLine1.setAttribute('stroke-width', '1.5');
            emptyLine1.setAttribute('opacity', '0.6');
            svg.appendChild(emptyLine1);

            var emptyLine2 = document.createElementNS(ns, 'line');
            emptyLine2.setAttribute('x1', '26');
            emptyLine2.setAttribute('y1', '28');
            emptyLine2.setAttribute('x2', '14');
            emptyLine2.setAttribute('y2', '40');
            emptyLine2.setAttribute('stroke', '#ef5350');
            emptyLine2.setAttribute('stroke-width', '1.5');
            emptyLine2.setAttribute('opacity', '0.6');
            svg.appendChild(emptyLine2);
          }

          // Sealed state: cork cap
          if (isSealed) {
            var cork = document.createElementNS(ns, 'rect');
            cork.setAttribute('x', '14');
            cork.setAttribute('y', '0');
            cork.setAttribute('width', '12');
            cork.setAttribute('height', '6');
            cork.setAttribute('rx', '2');
            cork.setAttribute('fill', '#37474f');
            svg.appendChild(cork);
          }

          return svg;
        }

        // ── Load categories (one-time) ──────────────────
        function loadCategories() {
          return db
            .collection('symposium_categories')
            .orderBy('sortOrder')
            .get()
            .then(function (snapshot) {
              snapshot.forEach(function (doc) {
                categoryMap[doc.id] = doc.data();
              });
              populateCategorySelect();
              renderFilterChips();
            });
        }

        function populateCategorySelect() {
          var keys = Object.keys(categoryMap);
          keys.forEach(function (id) {
            var opt = document.createElement('option');
            opt.value = id;
            opt.textContent = categoryMap[id].name;
            fieldCategory.appendChild(opt);
          });
        }

        // ── Category filter chips ───────────────────────
        function renderFilterChips() {
          chipsEl.innerHTML = '';

          var allChip = document.createElement('button');
          allChip.type = 'button';
          allChip.className = 'filter-chip' + (activeFilter === 'all' ? ' active' : '');
          allChip.textContent = 'All';
          allChip.addEventListener('click', function () {
            activeFilter = 'all';
            renderFilterChips();
            renderView();
          });
          chipsEl.appendChild(allChip);

          Object.keys(categoryMap).forEach(function (id) {
            var chip = document.createElement('button');
            chip.type = 'button';
            chip.className = 'filter-chip' + (activeFilter === id ? ' active' : '');
            chip.textContent = categoryMap[id].name;
            chip.addEventListener('click', function () {
              activeFilter = id;
              renderFilterChips();
              renderView();
            });
            chipsEl.appendChild(chip);
          });
        }

        // ── Subscribe to ingredients ────────────────────
        function subscribeToIngredients() {
          db.collection('symposium_ingredients')
            .orderBy('category')
            .orderBy('name')
            .onSnapshot(function (snapshot) {
              allIngredients = [];
              snapshot.forEach(function (doc) {
                allIngredients.push(Object.assign({ id: doc.id }, doc.data()));
              });
              renderView();
            });
        }

        // ── Filtering & sorting pipeline ─────────────────
        function getFilteredAndSorted() {
          var result = allIngredients.slice();

          // 1. Search filter (name, category name, tags)
          if (searchQuery) {
            var q = searchQuery.toLowerCase();
            result = result.filter(function (ing) {
              if (ing.name.toLowerCase().indexOf(q) !== -1) return true;
              var catName = categoryMap[ing.category] ? categoryMap[ing.category].name : '';
              if (catName.toLowerCase().indexOf(q) !== -1) return true;
              if (ing.tags && Array.isArray(ing.tags)) {
                return ing.tags.some(function (tag) {
                  return tag.toLowerCase().indexOf(q) !== -1;
                });
              }
              return false;
            });
          }

          // 2. Category filter
          if (activeFilter !== 'all') {
            result = result.filter(function (ing) {
              return ing.category === activeFilter;
            });
          }

          // 3. Stock filter
          if (stockFilter === 'in-stock') {
            result = result.filter(function (ing) {
              return ing.inStock === true;
            });
          }

          // 4. Sort
          result.sort(function (a, b) {
            if (activeSort === 'alpha') {
              return a.name.localeCompare(b.name);
            } else if (activeSort === 'category') {
              var catA = categoryMap[a.category] ? categoryMap[a.category].name : '';
              var catB = categoryMap[b.category] ? categoryMap[b.category].name : '';
              var catCmp = catA.localeCompare(catB);
              if (catCmp !== 0) return catCmp;
              return a.name.localeCompare(b.name);
            } else if (activeSort === 'stock') {
              if (a.inStock === b.inStock) return a.name.localeCompare(b.name);
              return a.inStock ? -1 : 1;
            }
            return 0;
          });

          return result;
        }

        // ── Category browse grid ──────────────────────────
        function shouldShowCategoryGrid() {
          return activeFilter === 'all' && !searchQuery && stockFilter === 'all';
        }

        function renderCategoryGrid() {
          categoryGrid.innerHTML = '';

          var catIds = Object.keys(categoryMap);
          catIds.forEach(function (catId) {
            var cat = categoryMap[catId];
            var count = allIngredients.filter(function (ing) {
              return ing.category === catId;
            }).length;
            var inStockCount = allIngredients.filter(function (ing) {
              return ing.category === catId && ing.inStock;
            }).length;

            var card = document.createElement('button');
            card.type = 'button';
            card.className = 'category-card';

            var nameEl = document.createElement('div');
            nameEl.className = 'category-card-name';
            nameEl.textContent = cat.name;

            var countEl2 = document.createElement('div');
            countEl2.className = 'category-card-count';
            countEl2.textContent = count + (count === 1 ? ' ingredient' : ' ingredients');

            var stockEl = document.createElement('div');
            stockEl.className = 'category-card-stock';
            stockEl.textContent = inStockCount + ' in stock';

            card.appendChild(nameEl);
            card.appendChild(countEl2);
            card.appendChild(stockEl);

            card.addEventListener('click', function () {
              activeFilter = catId;
              renderFilterChips();
              renderView();
            });

            categoryGrid.appendChild(card);
          });
        }

        // ── Master view orchestrator ──────────────────────
        function renderView() {
          if (shouldShowCategoryGrid()) {
            categoryGrid.classList.remove('hidden');
            controlsRow.classList.add('hidden');
            listEl.innerHTML = '';
            emptyEl.classList.add('hidden');
            countEl.classList.add('hidden');
            renderCategoryGrid();
          } else {
            categoryGrid.classList.add('hidden');
            controlsRow.classList.remove('hidden');
            renderList();
          }
        }

        // ── Render ingredient list ──────────────────────
        function renderList() {
          var filtered = getFilteredAndSorted();

          listEl.innerHTML = '';

          if (filtered.length === 0) {
            emptyEl.classList.remove('hidden');
            countEl.classList.add('hidden');

            if (searchQuery) {
              emptyEl.querySelector('.empty-state-icon').innerHTML = '&#128302;';
              emptyEl.querySelector('.empty-state-text').textContent =
                'The Oracle finds nothing by that name.';
            } else if (stockFilter !== 'all') {
              emptyEl.querySelector('.empty-state-icon').innerHTML = '&#127863;';
              emptyEl.querySelector('.empty-state-text').textContent =
                'No ingredients match this filter.';
            } else if (activeFilter !== 'all' && allIngredients.length > 0) {
              emptyEl.querySelector('.empty-state-icon').innerHTML = '&#127863;';
              emptyEl.querySelector('.empty-state-text').textContent =
                'No ingredients in this category yet.';
            } else {
              emptyEl.querySelector('.empty-state-icon').innerHTML = '&#127863;';
              emptyEl.querySelector('.empty-state-text').textContent =
                'The Cellar awaits its first offering.';
            }
            return;
          }

          emptyEl.classList.add('hidden');
          countEl.classList.remove('hidden');
          countEl.textContent =
            filtered.length + (filtered.length === 1 ? ' ingredient' : ' ingredients');

          filtered.forEach(function (ing) {
            listEl.appendChild(renderCard(ing));
          });
        }

        // ── Render a single ingredient card ─────────────
        function renderCard(ing) {
          var card = document.createElement('div');
          card.className = 'ingredient-card';

          var header = document.createElement('div');
          header.className = 'ingredient-card-header';

          var info = document.createElement('div');

          var name = document.createElement('h3');
          name.className = 'ingredient-name';
          name.textContent = ing.name;

          var meta = document.createElement('div');
          meta.className = 'ingredient-meta';

          var catBadge = document.createElement('span');
          catBadge.className = 'badge badge-category';
          catBadge.textContent = categoryMap[ing.category]
            ? categoryMap[ing.category].name
            : ing.category;
          meta.appendChild(catBadge);

          if (ing.subcategory) {
            var subBadge = document.createElement('span');
            subBadge.className = 'badge badge-subcategory';
            subBadge.textContent = ing.subcategory;
            meta.appendChild(subBadge);
          }

          var stockBadge = document.createElement('span');
          stockBadge.className =
            'badge badge-stock ' + (ing.inStock ? 'badge-in-stock' : 'badge-out-of-stock');
          stockBadge.textContent = ing.inStock ? 'In Stock' : 'Out of Stock';
          meta.appendChild(stockBadge);

          info.appendChild(name);
          info.appendChild(meta);

          var actions = document.createElement('div');
          actions.className = 'ingredient-actions';

          var editBtn = document.createElement('button');
          editBtn.type = 'button';
          editBtn.className = 'btn-icon btn-edit';
          editBtn.textContent = 'Edit';
          editBtn.addEventListener('click', function () {
            openModal(ing);
          });

          var deleteBtn = document.createElement('button');
          deleteBtn.type = 'button';
          deleteBtn.className = 'btn-icon btn-delete';
          deleteBtn.textContent = 'Delete';
          deleteBtn.addEventListener('click', function () {
            handleDelete(ing);
          });

          actions.appendChild(editBtn);
          actions.appendChild(deleteBtn);

          // Amphora bottle level indicator
          var amphoraBtn = document.createElement('button');
          amphoraBtn.type = 'button';
          amphoraBtn.className =
            'amphora-indicator' + (!ing.openBottleLevel ? ' amphora-sealed' : '');
          amphoraBtn.title = ing.openBottleLevel
            ? 'Bottle level: ' + (BOTTLE_LEVELS[ing.openBottleLevel] || {}).label
            : 'No open bottle (sealed)';

          amphoraBtn.appendChild(createAmphoraSVG(ing.openBottleLevel, 24));

          var amphoraLabelEl = document.createElement('span');
          amphoraLabelEl.className = 'amphora-label';
          amphoraLabelEl.textContent = ing.openBottleLevel
            ? (BOTTLE_LEVELS[ing.openBottleLevel] || {}).label || '?'
            : 'Sealed';
          amphoraBtn.appendChild(amphoraLabelEl);

          amphoraBtn.addEventListener('click', function (e) {
            e.stopPropagation();
            openAmphoraPopover(ing, amphoraBtn);
          });

          header.appendChild(info);
          header.appendChild(amphoraBtn);
          header.appendChild(actions);
          card.appendChild(header);

          // Details row
          var details = document.createElement('div');
          details.className = 'ingredient-details';

          var qtyDetail = document.createElement('span');
          qtyDetail.innerHTML =
            '<span class="ingredient-detail-label">Qty:</span> ' +
            (ing.quantity || 0) +
            ' ' +
            (ing.unit || '');
          details.appendChild(qtyDetail);

          if (ing.lowStockThreshold > 0) {
            var threshDetail = document.createElement('span');
            threshDetail.innerHTML =
              '<span class="ingredient-detail-label">Low at:</span> ' +
              ing.lowStockThreshold +
              ' ' +
              (ing.unit || '');
            details.appendChild(threshDetail);
          }

          card.appendChild(details);

          if (ing.tags && Array.isArray(ing.tags) && ing.tags.length > 0) {
            var tagsRow = document.createElement('div');
            tagsRow.className = 'ingredient-meta';
            tagsRow.style.marginTop = '0.5rem';
            ing.tags.forEach(function (tag) {
              var tagBadge = document.createElement('span');
              tagBadge.className = 'badge badge-subcategory';
              tagBadge.textContent = tag;
              tagsRow.appendChild(tagBadge);
            });
            card.appendChild(tagsRow);
          }

          if (ing.notes) {
            var notes = document.createElement('div');
            notes.className = 'ingredient-notes';
            notes.textContent = ing.notes;
            card.appendChild(notes);
          }

          return card;
        }

        // ── Modal open / close ──────────────────────────
        function openModal(ingredient) {
          editingId = ingredient ? ingredient.id : null;
          modalTitle.textContent = ingredient ? 'Edit Ingredient' : 'Add Ingredient';

          clearErrors();

          if (ingredient) {
            fieldName.value = ingredient.name || '';
            fieldCategory.value = ingredient.category || '';
            populateSubcategories(ingredient.category);
            fieldSubcategory.value = ingredient.subcategory || '';
            fieldUnit.value = ingredient.unit || '';
            fieldQuantity.value = ingredient.quantity != null ? ingredient.quantity : 0;
            fieldInStock.checked = !!ingredient.inStock;
            fieldTags.value =
              ingredient.tags && Array.isArray(ingredient.tags) ? ingredient.tags.join(', ') : '';
            fieldNotes.value = ingredient.notes || '';
            fieldShopping.checked = !!ingredient.shoppingListDefault;
            fieldThreshold.value =
              ingredient.lowStockThreshold != null ? ingredient.lowStockThreshold : 0;
          } else {
            formEl.reset();
            fieldQuantity.value = '0';
            fieldThreshold.value = '0';
            fieldSubcategory.innerHTML = '<option value="">Select category first</option>';
          }

          modalEl.classList.add('open');
          fieldName.focus();
        }

        function closeModal() {
          modalEl.classList.remove('open');
          editingId = null;
        }

        // ── Subcategory cascade ─────────────────────────
        function populateSubcategories(categoryId) {
          fieldSubcategory.innerHTML = '<option value="">Select&hellip;</option>';
          var cat = categoryMap[categoryId];
          if (cat && cat.subcategories) {
            cat.subcategories.forEach(function (sub) {
              var opt = document.createElement('option');
              opt.value = sub;
              opt.textContent = sub.charAt(0).toUpperCase() + sub.slice(1);
              fieldSubcategory.appendChild(opt);
            });
          }
        }

        // ── Validation ──────────────────────────────────
        function clearErrors() {
          var errors = formEl.querySelectorAll('.form-error');
          errors.forEach(function (el) {
            el.textContent = '';
          });
        }

        function setError(fieldId, msg) {
          var el = document.getElementById('error-' + fieldId);
          if (el) el.textContent = msg;
        }

        function validateForm() {
          clearErrors();
          var valid = true;

          if (!fieldName.value.trim()) {
            setError('name', 'Name is required');
            valid = false;
          }
          if (!fieldCategory.value) {
            setError('category', 'Category is required');
            valid = false;
          }
          if (!fieldSubcategory.value) {
            setError('subcategory', 'Subcategory is required');
            valid = false;
          }
          if (!fieldUnit.value) {
            setError('unit', 'Unit is required');
            valid = false;
          }
          if (fieldQuantity.value === '' || parseFloat(fieldQuantity.value) < 0) {
            setError('quantity', 'Quantity must be 0 or greater');
            valid = false;
          }

          return valid;
        }

        // ── Duplicate check ─────────────────────────────
        function checkDuplicate(name, category) {
          var trimmed = name.trim().toLowerCase();
          return allIngredients.some(function (ing) {
            return (
              ing.id !== editingId &&
              ing.name.toLowerCase() === trimmed &&
              ing.category === category
            );
          });
        }

        // ── Form submit ─────────────────────────────────
        function handleSubmit(e) {
          e.preventDefault();
          if (!validateForm()) return;

          var name = fieldName.value.trim();
          var category = fieldCategory.value;

          if (checkDuplicate(name, category)) {
            setError('name', 'An ingredient with this name already exists in this category');
            return;
          }

          var tags = fieldTags.value
            .split(',')
            .map(function (t) {
              return t.trim();
            })
            .filter(Boolean);

          var data = {
            name: name,
            category: category,
            subcategory: fieldSubcategory.value,
            tags: tags,
            unit: fieldUnit.value,
            type: 'consumable',
            inStock: fieldInStock.checked,
            quantity: parseFloat(fieldQuantity.value) || 0,
            notes: fieldNotes.value.trim(),
            shoppingListDefault: fieldShopping.checked,
            lowStockThreshold: parseFloat(fieldThreshold.value) || 0,
            updatedAt: serverTimestamp(),
          };

          var btnSave = document.getElementById('btn-save');
          btnSave.disabled = true;
          btnSave.textContent = 'Saving\u2026';

          var promise;
          if (editingId) {
            var existingIng = allIngredients.find(function (ing) {
              return ing.id === editingId;
            });
            data.createdAt = existingIng.createdAt;
            if (existingIng.openBottleLevel) {
              data.openBottleLevel = existingIng.openBottleLevel;
            }
            promise = db.collection('symposium_ingredients').doc(editingId).set(data);
          } else {
            data.createdAt = serverTimestamp();
            promise = db.collection('symposium_ingredients').add(data);
          }

          promise
            .then(function () {
              closeModal();
            })
            .catch(function (err) {
              console.error('Failed to save ingredient:', err);
              setError('name', 'Failed to save. Check console for details.');
            })
            .finally(function () {
              btnSave.disabled = false;
              btnSave.textContent = 'Save';
            });
        }

        // ── Delete ──────────────────────────────────────
        function handleDelete(ing) {
          if (!window.confirm('Remove "' + ing.name + '" from the cellar?')) {
            return;
          }

          db.collection('symposium_ingredients')
            .doc(ing.id)
            .delete()
            .catch(function (err) {
              console.error('Failed to delete ingredient:', err);
            });
        }

        // ── Amphora popover ────────────────────────────
        function openAmphoraPopover(ing, anchorEl) {
          if (
            amphoraPopoverIng &&
            amphoraPopoverIng.id === ing.id &&
            amphoraPopoverEl.classList.contains('open')
          ) {
            closeAmphoraPopover();
            return;
          }

          amphoraPopoverIng = ing;
          renderAmphoraOptions(ing);

          var rect = anchorEl.getBoundingClientRect();
          var popW = 220;
          var left = rect.left + rect.width / 2 - popW / 2;
          var top = rect.bottom + 8;

          if (left < 8) left = 8;
          if (left + popW > window.innerWidth - 8) left = window.innerWidth - 8 - popW;
          if (top + 300 > window.innerHeight) {
            top = rect.top - 8 - 300;
            if (top < 8) top = 8;
          }

          amphoraPopoverEl.style.left = left + 'px';
          amphoraPopoverEl.style.top = top + 'px';
          amphoraPopoverEl.classList.add('open');
        }

        function closeAmphoraPopover() {
          amphoraPopoverEl.classList.remove('open');
          amphoraPopoverIng = null;
        }

        function renderAmphoraOptions(ing) {
          amphoraOptionsEl.innerHTML = '';

          LEVEL_ORDER.forEach(function (levelKey) {
            var levelInfo = BOTTLE_LEVELS[levelKey];
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className =
              'amphora-level-btn' + (ing.openBottleLevel === levelKey ? ' active' : '');

            btn.appendChild(createAmphoraSVG(levelKey, 18));

            var labelSpan = document.createElement('span');
            labelSpan.textContent = levelInfo.label;
            btn.appendChild(labelSpan);

            btn.addEventListener('click', function () {
              handleAmphoraLevelChange(ing, levelKey);
            });

            amphoraOptionsEl.appendChild(btn);
          });

          var divider = document.createElement('div');
          divider.className = 'amphora-level-divider';
          amphoraOptionsEl.appendChild(divider);

          var sealedBtn = document.createElement('button');
          sealedBtn.type = 'button';
          sealedBtn.className =
            'amphora-level-btn amphora-sealed-btn' + (!ing.openBottleLevel ? ' active' : '');

          sealedBtn.appendChild(createAmphoraSVG(null, 18));

          var sealedLabel = document.createElement('span');
          sealedLabel.textContent = 'Sealed (no open bottle)';
          sealedBtn.appendChild(sealedLabel);

          sealedBtn.addEventListener('click', function () {
            handleAmphoraLevelChange(ing, null);
          });

          amphoraOptionsEl.appendChild(sealedBtn);
        }

        // ── Amphora level change ──────────────────────
        function handleAmphoraLevelChange(ing, newLevel) {
          var oldLevel = ing.openBottleLevel || null;

          if (newLevel === oldLevel) {
            closeAmphoraPopover();
            return;
          }

          // Optimistic UI update
          var localIng = allIngredients.find(function (i) {
            return i.id === ing.id;
          });
          if (localIng) {
            if (newLevel) {
              localIng.openBottleLevel = newLevel;
            } else {
              delete localIng.openBottleLevel;
            }
          }

          renderView();
          closeAmphoraPopover();

          // Prompt on empty
          var setShoppingList = false;
          if (newLevel === 'empty') {
            if (window.confirm('Bottle empty! Move "' + ing.name + '" to the shopping list?')) {
              setShoppingList = true;
              if (localIng) localIng.shoppingListDefault = true;
            }
          }

          // Build full document for .set()
          var currentDoc = allIngredients.find(function (i) {
            return i.id === ing.id;
          });
          if (!currentDoc) return;

          var data = {
            name: currentDoc.name,
            category: currentDoc.category,
            subcategory: currentDoc.subcategory,
            tags: currentDoc.tags || [],
            unit: currentDoc.unit,
            type: 'consumable',
            inStock: currentDoc.inStock,
            quantity: currentDoc.quantity || 0,
            notes: currentDoc.notes || '',
            shoppingListDefault: setShoppingList ? true : currentDoc.shoppingListDefault,
            lowStockThreshold: currentDoc.lowStockThreshold || 0,
            createdAt: currentDoc.createdAt,
            updatedAt: serverTimestamp(),
          };

          if (newLevel) {
            data.openBottleLevel = newLevel;
          }

          db.collection('symposium_ingredients')
            .doc(ing.id)
            .set(data)
            .catch(function (err) {
              console.error('Failed to update bottle level:', err);
              if (localIng) {
                if (oldLevel) {
                  localIng.openBottleLevel = oldLevel;
                } else {
                  delete localIng.openBottleLevel;
                }
              }
              renderView();
            });
        }

        // ── Event listeners ─────────────────────────────
        btnAdd.addEventListener('click', function () {
          openModal(null);
        });

        btnCancel.addEventListener('click', closeModal);

        modalEl.addEventListener('click', function (e) {
          if (e.target === modalEl) closeModal();
        });

        document.addEventListener('keydown', function (e) {
          if (e.key === 'Escape') {
            if (amphoraPopoverEl.classList.contains('open')) {
              closeAmphoraPopover();
            } else if (modalEl.classList.contains('open')) {
              closeModal();
            }
          }
        });

        document.addEventListener('click', function (e) {
          if (
            amphoraPopoverEl.classList.contains('open') &&
            !amphoraPopoverEl.contains(e.target) &&
            !e.target.closest('.amphora-indicator')
          ) {
            closeAmphoraPopover();
          }
        });

        window.addEventListener(
          'scroll',
          function () {
            if (amphoraPopoverEl.classList.contains('open')) {
              closeAmphoraPopover();
            }
          },
          true
        );

        window.addEventListener('resize', function () {
          if (amphoraPopoverEl.classList.contains('open')) {
            closeAmphoraPopover();
          }
        });

        fieldCategory.addEventListener('change', function () {
          populateSubcategories(fieldCategory.value);
        });

        formEl.addEventListener('submit', handleSubmit);

        // Search (debounced)
        searchInput.addEventListener('input', function () {
          clearTimeout(searchTimer);
          searchTimer = setTimeout(function () {
            var val = searchInput.value.trim();
            searchQuery = val;

            if (val) {
              searchClear.classList.remove('hidden');
            } else {
              searchClear.classList.add('hidden');
            }

            renderView();
          }, 200);
        });

        searchClear.addEventListener('click', function () {
          searchInput.value = '';
          searchQuery = '';
          searchClear.classList.add('hidden');
          renderView();
        });

        // Sort
        sortSelect.addEventListener('change', function () {
          activeSort = sortSelect.value;
          renderView();
        });

        // Stock filter toggle
        stockToggle.addEventListener('click', function () {
          if (stockFilter === 'all') {
            stockFilter = 'in-stock';
            stockToggle.classList.add('active');
            stockToggle.textContent = 'In Stock Only \u2713';
          } else {
            stockFilter = 'all';
            stockToggle.classList.remove('active');
            stockToggle.textContent = 'In Stock Only';
          }
          renderView();
        });

        // ── Init ────────────────────────────────────────
        loadCategories()
          .then(function () {
            subscribeToIngredients();
          })
          .catch(function (err) {
            console.error('Failed to load categories:', err);
          });
      }
    </script>
  </body>
</html>
