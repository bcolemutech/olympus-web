rules_version='2'

service cloud.firestore {
  match /databases/{database}/documents {
    function hasApp(appId) {
      return request.auth != null
          && request.auth.token.apps is list
          && appId in request.auth.token.apps;
    }

    match /apps/{appId} {
      allow read: if hasApp(appId);
      allow write: if false;
    }

    // ── The Symposium ──────────────────────────────────────

    match /symposium_ingredients/{ingredientId} {
      function validIngredient() {
        let data = request.resource.data;
        let required = [
          'name', 'category', 'subcategory', 'tags',
          'unit', 'type', 'inStock', 'quantity',
          'notes', 'shoppingListDefault', 'lowStockThreshold',
          'createdAt', 'updatedAt'
        ];
        let allowed = [
          'name', 'category', 'subcategory', 'tags',
          'unit', 'type', 'inStock', 'quantity',
          'notes', 'shoppingListDefault', 'lowStockThreshold',
          'createdAt', 'updatedAt', 'openBottleLevel'
        ];
        let validLevels = ['full', 'three-quarter', 'half', 'quarter', 'empty'];

        return data.keys().hasAll(required)
            && data.keys().hasOnly(allowed)
            && data.type == 'consumable'
            && data.unit in ['oz', 'ml', 'dash', 'each', 'splash']
            && exists(/databases/$(database)/documents/symposium_categories/$(data.category))
            && (!data.keys().hasAny(['openBottleLevel']) || data.openBottleLevel in validLevels);
      }

      allow read: if hasApp('symposium');
      allow create: if hasApp('symposium')
                    && validIngredient()
                    && request.resource.data.createdAt == request.time
                    && request.resource.data.updatedAt == request.time;
      allow update: if hasApp('symposium')
                    && validIngredient()
                    && request.resource.data.createdAt == resource.data.createdAt
                    && request.resource.data.updatedAt == request.time;
      allow delete: if hasApp('symposium');
    }

    match /symposium_equipment/{equipmentId} {
      function validEquipment() {
        let data = request.resource.data;
        let required = [
          'name', 'category', 'subcategory', 'tags',
          'type', 'quantity', 'condition',
          'notes', 'createdAt', 'updatedAt'
        ];
        let allowed = required;
        let validConditions = ['good', 'fair', 'replace'];

        return data.keys().hasAll(required)
            && data.keys().hasOnly(allowed)
            && data.type == 'reusable'
            && data.condition in validConditions
            && exists(/databases/$(database)/documents/symposium_categories/$(data.category));
      }

      allow read: if hasApp('symposium');
      allow create: if hasApp('symposium')
                    && validEquipment()
                    && request.resource.data.createdAt == request.time
                    && request.resource.data.updatedAt == request.time;
      allow update: if hasApp('symposium')
                    && validEquipment()
                    && request.resource.data.createdAt == resource.data.createdAt
                    && request.resource.data.updatedAt == request.time;
      allow delete: if hasApp('symposium');
    }

    match /symposium_recipes/{recipeId} {
      function validRecipe() {
        let data = request.resource.data;
        let required = [
          'name', 'category', 'subcategory', 'tags',
          'description', 'instructions', 'ingredients', 'equipment',
          'garnish', 'glassware', 'servings', 'canMake',
          'favorite', 'createdAt', 'updatedAt'
        ];
        let allowed = [
          'name', 'category', 'subcategory', 'tags',
          'description', 'instructions', 'ingredients', 'equipment',
          'garnish', 'glassware', 'servings', 'canMake',
          'imageUrl', 'source', 'favorite', 'createdAt', 'updatedAt'
        ];

        return data.keys().hasAll(required)
            && data.keys().hasOnly(allowed)
            && data.servings is int
            && data.servings > 0
            && data.canMake is bool
            && data.favorite is bool
            && data.ingredients is list
            && data.equipment is list
            && data.tags is list
            && exists(/databases/$(database)/documents/symposium_categories/$(data.category));
      }

      allow read: if hasApp('symposium');
      allow create: if hasApp('symposium')
                    && validRecipe()
                    && request.resource.data.createdAt == request.time
                    && request.resource.data.updatedAt == request.time;
      allow update: if hasApp('symposium')
                    && validRecipe()
                    && request.resource.data.createdAt == resource.data.createdAt
                    && request.resource.data.updatedAt == request.time;
      allow delete: if hasApp('symposium');
    }

    match /symposium_categories/{categoryId} {
      allow read: if hasApp('symposium');
      allow write: if false;
    }

    // ── Default deny ───────────────────────────────────────

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
